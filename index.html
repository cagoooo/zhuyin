<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„ÑÖ„ÑÜ„Ñá Ê≥®Èü≥Â§ßÊåëÊà∞ üé≤ </title>
    <link rel="icon" href="https://fav.farm/üé≤">
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ê≥®Èü≥Â§ßÊåëÊà∞">
    <meta name="theme-color" content="#4F46E5">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%234F46E5'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='300' fill='white' text-anchor='middle' dy='.3em'%3Eüé≤%3C/text%3E%3C/svg%3E">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&family=Comic+Neue:wght@300;400;700&display=swap');

        :root {
            /* v3.0.0 Claymorphism ‰∏ªËâ≤ÂΩ©Áõ§ (AI Êô∫ËÉΩÁâà) */
            --primary-color: #4F46E5;
            /* Ê¥ªÂäõÈùõËóç */
            --primary-color-hover: #4338CA;
            --secondary-color: #818CF8;
            /* ÊüîÂíåËóç */
            --bg-color: #EEF2FF;
            /* Ê•µÊ∑°ËóçËÉåÊôØ */
            --text-color: #1E1B4B;
            /* Ê∑±ÈÇÉÂçàÂ§úËóç (È´òÂ∞çÊØîÂ∫¶ÊñáÂ≠ó) */

            /* CTA ËàáÂõûÈ•ãËâ≤ÂΩ© */
            --accent-color: #F97316;
            /* ÂÖÉÊ∞£Ê©ò */
            --accent-color-hover: #EA580C;
            --heart-red: #EF4444;
            /* ÈåØË™§Á¥Ö/ÊÑõÂøÉÁ¥Ö */

            /* Claymorphism ÈªèÂúüÈ¢®Ê†ºÂ∞àÁî®Èô∞ÂΩ±ËÆäÊï∏ */
            --clay-shadow-out: 8px 8px 16px rgba(166, 180, 246, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.9);
            --clay-shadow-btn: 3px 6px 0px rgba(0, 0, 0, 0.15), inset 0px 4px 5px rgba(255, 255, 255, 0.4), inset 0px -4px 5px rgba(0, 0, 0, 0.1);
            --clay-shadow-btn-active: 0px 0px 0px rgba(0, 0, 0, 0), inset 0px 6px 6px rgba(0, 0, 0, 0.15), inset 0px -2px 5px rgba(255, 255, 255, 0.3);

            /* ÂúìËßíÂ∞∫ÂØ∏Ë®≠ÂÆö */
            --border-radius-btn: 20px;
            --border-radius-card: 32px;

            /* Êñ∞Â¢û Claymorphism Ê†∏ÂøÉËÆäÊï∏ (v3.0) */
            --clay-bg: #FFFFFF;
            --clay-inner-top: inset 2px 2px 5px rgba(255, 255, 255, 0.8);
            --clay-inner-bottom: inset -5px -5px 10px rgba(166, 180, 246, 0.4);
            --clay-outer-soft: 10px 10px 20px rgba(166, 180, 246, 0.3);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            background-color: var(--primary-color);
            background-image: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.05) 0, rgba(255, 255, 255, 0.05) 20px, transparent 20px, transparent 40px);
        }

        body {
            font-family: 'Baloo 2', 'Comic Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-world {
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 900px;
            background: var(--bg-color);
            box-shadow: var(--clay-shadow-out);
            border-radius: var(--border-radius-card);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 4px solid #fff;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out, visibility 0.4s;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        .scrollable-screen {
            justify-content: flex-start;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 40px;
            padding-bottom: 40px;
        }

        .scrollable-screen>* {
            flex-shrink: 0;
            max-width: 100%;
        }

        .btn {
            font-family: 'Baloo 2', 'Comic Neue', sans-serif;
            font-weight: 700;
            font-size: clamp(20px, 4vw, 26px);
            padding: 14px 36px;
            border-radius: var(--border-radius-btn);
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--clay-shadow-btn);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-4px) scale(1.03);
            background-color: var(--primary-color-hover);
        }

        .btn:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: var(--clay-shadow-btn-active);
        }

        #start-screen {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
        }

        #start-screen h1 {
            font-family: 'Baloo 2', 'Comic Neue', sans-serif;
            font-size: clamp(45px, 14vw, 75px);
            font-weight: 800;
            color: #fff;
            /* ÈÄ≤ÈöéÁ´ãÈ´îÂ†ÜÁñäÊñáÂ≠óÈô∞ÂΩ± */
            text-shadow:
                0 1px 0 #ccc,
                0 2px 0 #c9c9c9,
                0 3px 0 #bbb,
                0 4px 0 #b9b9b9,
                0 5px 0 #aaa,
                0 6px 1px rgba(0, 0, 0, .1),
                0 0 5px rgba(0, 0, 0, .1),
                0 1px 3px rgba(0, 0, 0, .3),
                0 3px 5px rgba(0, 0, 0, .2),
                0 5px 10px rgba(0, 0, 0, .25),
                0 10px 10px rgba(0, 0, 0, .2),
                0 20px 20px rgba(0, 0, 0, .15),
                2px 4px 0px var(--primary-color);
            margin-bottom: 30px;
            letter-spacing: 4px;
            text-align: center;
            animation: floating 3s ease-in-out infinite;
            background: linear-gradient(to bottom, #ffffff 0%, #f1f1f1 50%, #e1e1e1 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        @keyframes floating {

            0%,
            100% {
                transform: translateY(0) rotate(-1deg);
            }

            50% {
                transform: translateY(-15px) rotate(1deg);
            }
        }

        #level-select-screen {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            justify-content: flex-start;
            padding-top: 40px;
        }

        #level-select-screen h2 {
            font-size: clamp(30px, 8vw, 40px);
            margin-bottom: 20px;
            color: var(--text-color);
            text-shadow: 1px 1px 0px #fff;
        }

        .map-buttons-row {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .endless-mode-btn {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            padding: 12px 30px;
            font-size: 20px;
            font-weight: 800;
            border-radius: 30px;
            box-shadow: 0 6px 0 #92400E, var(--clay-shadow-btn);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0% {
                transform: scale(1);
                box-shadow: 0 6px 0 #92400E, 0 0 0 rgba(245, 158, 11, 0);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 0 #92400E, 0 0 20px rgba(245, 158, 11, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 6px 0 #92400E, 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        .endless-mode-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #92400E;
        }

        .level-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            max-width: 800px;
            justify-content: center;
        }

        .level-btn {
            width: 100%;
            aspect-ratio: 1 / 1;
            height: auto;
            font-size: clamp(12px, 3.5vw, 18px);
            font-family: 'Baloo 2', sans-serif;
            font-weight: 700;
            border-radius: var(--border-radius-btn);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            padding: 6px 4px;
            line-height: 1.2;
            border: 2px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        /* ÂêâÁ••Áâ©ÂÆπÂô® */
        #mascot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            z-index: 2000;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.1));
        }

        #mascot-svg {
            width: 100%;
            height: 100%;
        }

        .mascot-bubble {
            position: absolute;
            top: -60px;
            right: 0;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            white-space: nowrap;
            color: var(--text-color);
            border: 2px solid var(--primary-color);
        }

        .mascot-bubble.show {
            opacity: 1;
            transform: translateY(0);
        }

        .mascot-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 25px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
        }

        @keyframes mascot-idle {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        @keyframes mascot-bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2) translateY(-20px);
            }
        }

        .mascot-idle {
            animation: mascot-idle 3s infinite ease-in-out;
        }

        .mascot-bounce {
            animation: mascot-bounce 0.5s ease;
        }

        .level-btn:not(.locked):nth-child(5n+1) {
            background-color: var(--clay-peach);
            border-color: #FFB6C1;
        }

        .level-btn:not(.locked):nth-child(5n+2) {
            background-color: var(--clay-mint);
            border-color: #98FF98;
        }

        .level-btn:not(.locked):nth-child(5n+3) {
            background-color: var(--clay-sky);
            border-color: #87CEFA;
        }

        .level-btn:not(.locked):nth-child(5n+4) {
            background-color: var(--clay-banana);
            border-color: #F0E68C;
        }

        .level-btn:not(.locked):nth-child(5n+5) {
            background-color: var(--clay-lilac);
            border-color: #DDA0DD;
        }

        .level-btn.locked {
            background: #D1D5DB;
            color: #9CA3AF;
            border-color: #E5E7EB;
            box-shadow: inset -2px -2px 6px rgba(0, 0, 0, 0.1), 4px 4px 8px rgba(0, 0, 0, 0.15);
        }

        .level-btn .hearts {
            font-size: clamp(10px, 2.5vw, 16px);
            line-height: 1;
        }

        .level-icon {
            font-size: clamp(22px, 6vw, 36px);
            margin-bottom: 2px;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.1));
        }

        #reset-progress-btn {
            position: fixed;
            /* ÊîπÁÇ∫ fixed ÈÅøÂÖçËàáÊç≤ÂãïÂÖßÂÆπÈáçÁñä */
            bottom: 20px;
            right: 140px;
            /* ÂæÄÂ∑¶ÁßªÈÅøÂÖçË∑üÂêâÁ••Áâ©ÈáçÁñä */
            font-size: 14px;
            padding: 8px 15px;
            background-color: var(--danger-color);
            z-index: 100;
            /* Á¢∫‰øù‰∏çË¢´Êñ∞ÈóúÂç°Âç°ÁâáÈÅÆÊìã */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Â¢ûÂä†Èô∞ÂΩ±ÊèêÂçáËæ®Ë≠òÂ∫¶ */
        }



        .voice-btn {
            background: #FF4D4D;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px #CC0000;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-left: 20px;
        }

        .voice-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #CC0000;
        }

        .voice-btn.recording {
            animation: pulse-red 1.5s infinite;
            background: #ff0000;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(255, 77, 77, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);
            }
        }

        #radar-chart-container {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--clay-shadow-card);
            text-align: center;
            width: 100%;
        }

        #radar-canvas {
            max-width: 100%;
            height: auto;
        }

        #timer-display {
            font-size: 24px;
            font-weight: bold;
            color: #e5383b;
            margin: 0 10px;
            display: none;
        }

        .timer-warning {
            animation: pulse-red 0.5s infinite alternate;
        }

        @keyframes pulse-red {
            from {
                color: #e5383b;
                transform: scale(1);
            }

            to {
                color: #800f13;
                transform: scale(1.1);
            }
        }

        #game-screen {
            justify-content: space-between;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        .lives {
            font-size: 24px;
        }

        .progress-bar {
            flex-grow: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            overflow: hidden;
            margin: 0 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 2px 5px rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
            position: relative;
        }

        .progress-bar-inner {
            width: 0%;
            height: 100%;
            background: linear-gradient(180deg, #60A5FA 0%, #3B82F6 100%);
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Â∏∂Êúâ‰∏ÄÈªûË∂ÖË™øÁöÑÂΩàÊÄßÂãïÁï´ */
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6), inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* ÈÄ≤Â∫¶Ê¢ùÈ´òÂÖâÂèçÂ∞Ñ */
        .progress-bar-inner::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            height: 6px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.1));
            border-radius: 4px;
        }

        .top-buttons {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            font-size: 20px;
            width: 40px;
            height: 40px;
            padding: 0;
            line-height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            box-shadow: var(--clay-shadow-btn);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            transform: translateY(-2px) scale(1.05);
        }

        .icon-btn:active {
            transform: translateY(2px) scale(0.95);
            box-shadow: var(--clay-shadow-btn-active);
        }

        .quiz-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            flex-grow: 1;
            position: relative;
        }

        .question-image {
            width: clamp(150px, 30vh, 200px);
            height: clamp(150px, 30vh, 200px);
            object-fit: contain;
            margin-bottom: 20px;
            z-index: 2;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.15));
        }

        #combo-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: clamp(24px, 6vw, 36px);
            font-family: 'Baloo 2', sans-serif;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 4px 6px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        #combo-display.active {
            opacity: 1;
            transform: scale(1) rotate(-10deg);
        }

        .speech-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(28px, 5vw, 36px);
            width: clamp(50px, 10vw, 70px);
            height: clamp(50px, 10vw, 70px);
            border-radius: 50%;
            background-color: var(--clay-sky);
            border: 3px solid rgba(255, 255, 255, 0.9);
            color: #1E40AF;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5), var(--clay-shadow-btn);
            cursor: pointer;
            z-index: 5;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: pulse-glow 2.5s infinite;
            position: absolute;
            top: -20px;
            right: -15px;
        }

        .speech-btn:hover {
            transform: scale(1.1);
        }

        .speech-btn:active {
            transform: translateY(2px) scale(0.95);
            box-shadow: var(--clay-shadow-btn-active);
        }

        #interaction-area {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.85);
            padding: 15px 30px;
            border-radius: 40px;
            box-shadow: var(--clay-shadow-card);
            border: 4px solid white;
            margin-bottom: 20px;
        }

        #char-display {
            font-family: 'Baloo 2', sans-serif;
            font-weight: 700;
            font-size: clamp(80px, 20vw, 130px);
            margin-right: 20px;
            color: var(--text-color);
            text-shadow: 2px 2px 0px #fff;
        }

        #bopomofo-answer {
            font-family: 'Baloo 2', sans-serif;
            font-weight: 700;
            font-size: clamp(38px, 8vw, 45px);
            color: var(--primary-color);
            background: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 60px;
            min-height: 50px;
        }

        .keyboard {
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--border-radius-card);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
        }

        .bopomofo-group {
            margin-bottom: 8px;
            text-align: center;
        }

        .bopomofo-btn {
            font-family: 'Comic Neue', sans-serif;
            font-weight: 700;
            width: clamp(35px, 8.5vw, 48px);
            height: clamp(35px, 8.5vw, 48px);
            font-size: clamp(18px, 4vw, 26px);
            margin: 3px;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background: #fff;
            color: var(--text-color);
            box-shadow: var(--clay-shadow-btn);
        }

        /* Keyboard pastel colors */
        #consonants .bopomofo-btn {
            background-color: var(--clay-sky);
        }

        #medians .bopomofo-btn {
            background-color: var(--clay-peach);
        }

        #vowels .bopomofo-btn {
            background-color: var(--clay-banana);
        }

        #tones .bopomofo-btn {
            background-color: var(--clay-mint);
            font-size: clamp(32px, 7vw, 42px);
            padding-top: 10px;
            /* Â∞á‰∏äÊµÆÁöÑËÅ≤Ë™øÂæÄ‰∏ãÂ£ìÁΩÆ‰∏≠ */
            font-weight: 900;
        }

        .keyboard-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }

        .control-btn {
            font-size: clamp(15px, 3.8vw, 20px);
            font-weight: 800;
            padding: 10px 16px;
            min-height: 48px;
            border: 3px solid rgba(255, 255, 255, 0.7);
            letter-spacing: 0.5px;
        }

        .hint-btn {
            background-color: #FBBF24 !important;
            color: #451A03 !important;
            text-shadow: none !important;
            box-shadow: 0 5px 0 #92400E, var(--clay-shadow-btn);
        }

        .hint-btn:hover {
            background-color: #F59E0B;
        }

        .hint-btn:active {
            box-shadow: 0 2px 0 #92400E;
            transform: translateY(3px);
        }

        .clear-btn {
            background-color: #F1F5F9 !important;
            color: #1E293B !important;
            text-shadow: none !important;
            box-shadow: 0 5px 0 #94A3B8, var(--clay-shadow-btn);
        }

        .clear-btn:hover {
            background-color: #E2E8F0;
        }

        .clear-btn:active {
            box-shadow: 0 2px 0 #94A3B8;
            transform: translateY(3px);
        }

        .check-btn {
            background-color: #22C55E !important;
            color: white !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
            font-size: clamp(16px, 4vw, 22px);
            font-weight: 800;
            padding: 10px 22px;
            box-shadow: 0 5px 0 #15803D, var(--clay-shadow-btn);
        }

        .check-btn:hover {
            background-color: #16A34A;
        }

        .check-btn:active {
            box-shadow: 0 2px 0 #15803D;
            transform: translateY(3px);
        }

        .bopomofo-btn:hover {
            transform: translateY(-2px);
            color: var(--primary-color);
            filter: brightness(1.05);
        }

        .bopomofo-btn:active {
            transform: translateY(2px) scale(0.95);
            box-shadow: var(--clay-shadow-btn-active);
            filter: brightness(0.95);
        }

        #feedback-message {
            font-family: 'Baloo 2', sans-serif;
            font-size: clamp(22px, 5vw, 26px);
            font-weight: 700;
            height: 35px;
            margin-top: 15px;
            text-shadow: 1px 1px 0px #fff;
        }

        .feedback-correct {
            color: var(--success-color);
        }

        .feedback-wrong {
            color: var(--danger-color);
        }

        /* Á≠îÈåØÊ≥®Èü≥Â∞èÂç° */
        #answer-hint-card {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            background: white;
            border: 3px solid var(--danger-color);
            border-radius: 16px;
            padding: 8px 18px;
            font-family: 'Baloo 2', sans-serif;
            font-size: clamp(18px, 4.5vw, 24px);
            font-weight: 700;
            color: var(--danger-color);
            box-shadow: 0 4px 0 #B91C1C, var(--clay-shadow-btn);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            transition: opacity 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #answer-hint-card.show {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        #answer-hint-card.hide {
            opacity: 0;
            transform: translateX(-50%) scale(0.8);
        }

        /* ÈÄ£ÊìäÂçáÁ¥öÁâπÊïà 2.0 */
        #combo-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            font-weight: 900;
            color: #FF9F1C;
            text-shadow: 3px 3px 0px #fff, 0 0 10px rgba(255, 159, 28, 0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            font-family: 'Baloo 2', sans-serif;
        }

        #combo-display.active {
            opacity: 1;
            animation: combo-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #combo-display.fire {
            color: #FF4D00;
            text-shadow: 0 0 15px #FFD700, 3px 3px 0px #fff;
            animation: combo-burn 0.4s infinite alternate;
        }

        @keyframes combo-bounce {
            0% {
                transform: scale(0.5) rotate(-20deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes combo-burn {
            from {
                transform: scale(1.1);
                filter: brightness(1.2) drop-shadow(0 0 5px #ff0000);
            }

            to {
                transform: scale(1.2);
                filter: brightness(1.5) drop-shadow(0 0 20px #ff9900);
            }
        }

        /* ÊéíË°åÊ¶úËàáÁµêÁÆóÈù¢ÊùøÂ¢ûÂº∑ */
        .leaderboard-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
            box-shadow: var(--clay-shadow-btn);
            border: 2px solid #ddd;
        }

        .leaderboard-title {
            font-size: 18px;
            font-weight: 800;
            color: #4F46E5;
            margin-bottom: 10px;
            border-bottom: 2px dashed #4F46E5;
            padding-bottom: 5px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-weight: 700;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item .rank {
            color: #F59E0B;
            width: 25px;
        }

        .leaderboard-item .score {
            color: #10B981;
        }

        #score-display {
            font-size: 40px;
            font-weight: 900;
            background: linear-gradient(to bottom, #FFD700, #F59E0B);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
        }

        @keyframes celebrate {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        #interaction-area.correct {
            animation: celebrate 0.5s ease-in-out;
        }

        #interaction-area.wrong {
            animation: shake 0.4s ease-in-out;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            opacity: 1;
            pointer-events: none;
            z-index: 9999;
            animation: fall 1.8s ease-out forwards;
        }

        .confetti-round {
            border-radius: 50%;
        }

        .confetti-star {
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }

        .confetti-heart {
            clip-path: path('M5,2 A3,3,0,0,1,10,2 A3,3,0,0,1,10,7 L5,12 L0,7 A3,3,0,0,1,0,2 A3,3,0,0,1,5,2Z');
        }

        .confetti-square {
            border-radius: 2px;
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 1;
            }

            60% {
                opacity: 1;
            }

            100% {
                transform: translateY(120vh) rotate(720deg) scale(0.5);
                opacity: 0;
            }
        }

        #achievements-screen {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            justify-content: flex-start;
            padding-top: 40px;
        }

        #achievements-screen h2 {
            font-size: clamp(30px, 8vw, 40px);
            margin-bottom: 20px;
            color: var(--accent-color);
            text-shadow: 2px 2px 0px #fff;
        }

        #achievements-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-height: 70%;
            overflow-y: auto;
            padding: 10px;
        }

        .achievement-badge {
            width: 110px;
            height: 110px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: var(--clay-shadow-btn);
            border: 4px solid #eee;
            filter: grayscale(100%);
            opacity: 0.5;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
        }

        .achievement-badge.unlocked {
            filter: grayscale(0%);
            opacity: 1;
            border-color: #fca311;
            box-shadow: var(--clay-shadow-out), inset 0 0 10px rgba(252, 163, 17, 0.5);
            animation: unlock-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .achievement-badge .icon {
            font-size: 40px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .achievement-badge .name {
            font-size: 16px;
            font-family: 'Baloo 2', sans-serif;
            font-weight: 700;
            color: var(--text-color);
        }

        @keyframes unlock-pop {
            0% {
                transform: scale(0.5);
            }

            80% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .keyboard-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }

        .hint-btn {
            background-color: var(--warning-color);
            color: #fff;
            box-shadow: var(--clay-shadow-btn);
        }

        .hint-btn:disabled {
            background-color: #D1D5DB;
            color: #9CA3AF;
            box-shadow: inset 0px 4px 5px rgba(255, 255, 255, 0.4), inset 0px -4px 5px rgba(0, 0, 0, 0.1);
            cursor: not-allowed;
            border-color: transparent;
        }

        @keyframes fall {
            to {
                transform: translateY(200px) rotate(360deg);
                opacity: 0;
            }
        }

        #level-end-screen {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        #level-review-screen {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        #level-end-screen h2,
        #level-review-screen h2 {
            font-size: clamp(30px, 8vw, 40px);
            color: #fff;
            text-shadow: 2px 2px 0px var(--primary-color);
        }

        #level-end-hearts {
            font-size: clamp(30px, 8vw, 40px);
            margin: 10px 0;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
        }

        #level-end-hearts .heart {
            display: inline-block;
            color: #ddd;
            transition: color 0.3s;
        }

        #level-end-hearts .heart.active {
            color: var(--heart-red);
            animation: heart-pop 0.5s ease-out;
        }

        @keyframes heart-pop {
            0% {
                transform: scale(0);
            }

            80% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        #level-review-screen {
            justify-content: space-between;
        }

        #review-items-container {
            width: 100%;
            max-height: 60%;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 10px;
        }

        .review-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius-btn);
            padding: 15px;
            width: 160px;
            box-shadow: var(--clay-shadow-btn);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid transparent;
        }

        .review-item.wrong {
            border-color: var(--danger-color);
            background-color: #FEF2F2;
        }

        .review-item.correct {
            border-color: var(--success-color);
            background-color: #F0FDF4;
        }

        .review-text {
            font-family: 'Baloo 2', sans-serif;
            font-size: 24px;
            font-weight: 700;
            text-align: left;
            color: var(--text-color);
        }

        .review-text span {
            display: block;
            font-size: 16px;
            font-family: 'Comic Neue', sans-serif;
            color: var(--primary-color);
        }

        .review-icon {
            font-size: 30px;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
        }

        .phonetic-block-wrapper {
            display: flex;
            align-items: center;
        }

        .phonetic-wrapper {
            position: relative;
            padding-top: 0.5em;
        }

        .light-tone-dot {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* --- v3.0 Claymorphism Â∞àÂ±¨È°ûÂà• --- */
        .clay-card {
            background: var(--clay-bg);
            border-radius: var(--border-radius-card);
            box-shadow: var(--clay-outer-soft), var(--clay-inner-top), var(--clay-inner-bottom);
            padding: 25px;
            border: 4px solid #fff;
            transition: transform 0.3s ease;
            position: relative;
        }

        .clay-card:hover {
            transform: translateY(-5px);
        }

        .qr-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(238, 242, 255, 0.95);
            backdrop-filter: blur(15px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            -webkit-backdrop-filter: blur(15px);
        }

        .qr-overlay h3 {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 25px;
            text-shadow: 2px 2px 0px #fff;
        }

        .lobby-player-item {
            background: #fff;
            border-radius: 15px;
            padding: 12px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--clay-shadow-btn);
            border: 2px solid var(--secondary-color);
            font-weight: 700;
            animation: slide-in 0.3s ease-out forwards;
        }

        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .room-code-badge {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 28px;
            font-weight: 900;
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
            margin: 10px 0;
            letter-spacing: 2px;
        }

        .phonetic-block-horizontal {
            display: flex;
            align-items: flex-start;
        }

        .phonetic-block-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .vowel-cluster {
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.8em;
            line-height: 1;
            margin-left: 2px;
        }

        .phonetic-block-vertical .vowel-cluster {
            margin-left: 0;
        }

        .tone-block {
            font-size: 0.8em;
            line-height: 1;
            margin-left: 5px;
            position: relative;
            top: 8px;
        }

        @media (min-width: 600px) and (min-height: 600px) {
            .game-world {
                max-width: 800px;
                width: 95vw;
                height: 95vh;
                max-height: 900px;
            }

            .level-btn {
                width: 150px;
                height: 150px;
                font-size: 30px;
            }

            .level-icon {
                font-size: 40px;
            }

            .achievement-badge {
                width: 130px;
                height: 130px;
            }

            .achievement-badge .icon {
                font-size: 50px;
            }

            .quiz-content {
                flex-direction: row;
            }

            .question-image {
                width: 30vh;
                height: 30vh;
                margin-right: 5vw;
                margin-bottom: 0;
            }

            .speech-btn {
                margin-right: 20px;
                margin-bottom: 0;
            }
        }

        /* ÂãïÊÖã‰∏ªÈ°åËÉåÊôØÊïàÊûú */
        #game-screen {
            transition: background-color 0.5s;
        }

        .theme-rain {
            background: linear-gradient(to bottom, #778da9 0%, #415a77 100%);
        }

        .theme-rain .quiz-content {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="20"><line x1="5" y1="0" x2="5" y2="10" stroke="%23ffffff" stroke-width="1" stroke-dasharray="2, 5" opacity="0.3" /></svg>');
            background-size: 20px 40px;
            animation: rain-fall 1s linear infinite;
        }

        @keyframes rain-fall {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 0 40px;
            }
        }

        .theme-star {
            background: linear-gradient(to bottom, #020024 0%, #090979 35%, #00d4ff 100%);
            color: white;
        }

        .theme-warm {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        }

        .theme-food {
            background-color: #fff3b0;
        }

        .theme-fruit {
            background-color: #ffecd1;
        }

        /* --- Êñ∞Â¢ûÈóúÂç°‰∏ªÈ°å --- */
        .theme-nature {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        }

        .theme-insect {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        }

        .theme-action {
            background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%);
        }

        .theme-daily {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        /* --- Parent Dashboard Styles --- */
        .parent-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: #f8fafc;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--clay-shadow-btn);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .parent-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        .custom-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 16px;
            box-shadow: var(--clay-shadow-btn);
        }

        .custom-item-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .delete-btn {
            background: var(--heart-red);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .qr-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        #qrcode {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin: 20px;
        }

        .form-group {
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #ddd;
            font-size: 16px;
        }

        #custom-pool-list {
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
        }

        /* --- Custom Confirm Modal --- */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .confirm-modal-card {
            background: var(--clay-bg);
            border-radius: 30px;
            box-shadow: var(--clay-outer-soft), var(--clay-inner-top);
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 4px solid #fff;
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirm-modal-title {
            font-size: 24px;
            color: var(--accent-color);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .confirm-modal-text {
            color: #475569;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-modal-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-modal-btns .btn {
            flex: 1;
            margin: 0;
            padding: 12px;
        }

        /* --- Parent Lock Modal --- */
        #parent-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .parent-lock-card {
            background: white;
            border-radius: 30px;
            padding: 30px;
            text-align: center;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 5px solid var(--accent-color);
        }

        #lock-question {
            font-size: 28px;
            font-weight: 900;
            color: #1e293b;
            margin: 20px 0;
            letter-spacing: 2px;
        }

        #lock-input {
            width: 100%;
            font-size: 32px;
            text-align: center;
            padding: 10px;
            border-radius: 15px;
            border: 3px solid #e2e8f0;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        /* --- Health Alert --- */
        #health-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #6BCB77;
            z-index: 4000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 30px;
        }

        .health-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: floating 3s ease-in-out infinite;
        }

        #health-timer {
            font-size: 24px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.1);
            padding: 10px 25px;
            border-radius: 30px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="game-world">
        <!-- Áï´Èù¢ÂÆπÂô® -->
        <div id="start-screen" class="screen active">
            <button class="parent-btn" id="open-parent-btn">‚öôÔ∏è ÂÆ∂Èï∑Ê®°Âºè</button>
            <h1>„ÑÖ„ÑÜ„Ñá Ê≥®Èü≥Â§ßÊåëÊà∞</h1>
            <p>Ê∫ñÂÇôÂ•ΩÈñãÂßãÂ≠∏Áøí‰∫ÜÂóéÔºü</p><button id="start-game-btn" class="btn">ÈñãÂßãÂÜíÈö™</button>
            <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                <button id="achievements-btn" class="btn"
                    style="background-color: #fca311; box-shadow: 0 4px #d08c00;">üèÜ
                    Ê¶ÆËÄÄÊ¶ú</button>
                <button id="shop-btn" class="btn" style="background-color: #ec4899; box-shadow: 0 4px #be185d;">üõçÔ∏è
                    ÂïÜÂüé</button>
                <button id="open-multiplayer-btn" class="btn" style="background-color: #4CAF50;">üè´ Â§ö‰∫∫ÈÄ£Á∑ö</button>
            </div>
        </div>
        <div id="level-select-screen" class="screen scrollable-screen">
            <button class="parent-btn" id="back-to-home-from-map" style="left: 20px; right: auto;">üè† ËøîÂõû</button>
            <h2>ÈÅ∏ÊìáÈóúÂç°</h2>
            <div class="map-buttons-row">
                <button id="endless-mode-btn" class="endless-mode-btn">üî• ÁÑ°Áõ°ÊåëÊà∞</button>
                <button id="reset-progress-btn" class="btn">ÈáçÁΩÆÈÄ≤Â∫¶</button>
            </div>
            <div id="level-buttons-container" class="level-buttons"></div>
        </div>
        <div id="achievements-screen" class="screen scrollable-screen">
            <h2>üèÜ Ê¶ÆËÄÄÂæΩÁ´†</h2>
            <div id="achievements-container"></div><br><button id="back-to-start-btn" class="btn">ÂõûÈ¶ñÈ†Å</button>
        </div>
        <div id="shop-screen" class="screen scrollable-screen"
            style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);">
            <h2>üõçÔ∏è ËôõÊì¨ÂïÜÂüé</h2>
            <div
                style="background: white; padding: 10px 20px; border-radius: 30px; font-size: 24px; font-weight: bold; color: #F59E0B; margin-bottom: 20px; box-shadow: var(--clay-shadow-btn);">
                ÊàëÁöÑË≤°ÂØåÔºöüí∞ <span id="shop-coin-count">0</span>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                <button class="btn shop-tab-btn active" data-tab="hats" style="padding: 10px 20px; font-size: 18px;">üé©
                    Â∏ΩÂ≠ê</button>
                <button class="btn shop-tab-btn" data-tab="colors"
                    style="padding: 10px 20px; font-size: 18px; filter: grayscale(1); opacity: 0.6;">üé® È°èËâ≤
                    (Âç≥Â∞áÊé®Âá∫)</button>
            </div>

            <div id="shop-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 100%; max-width: 600px;">
                <!-- ÂïÜÂìÅÊúÉË¢´ÂãïÊÖãÊ≥®ÂÖ•ÈÄôË£° -->
            </div>

            <button id="close-shop-btn" class="btn" style="margin-top: 30px;">ËøîÂõûÈ¶ñÈ†Å</button>
        </div>
        <div id="game-screen" class="screen">
            <div class="top-bar">
                <div id="lives-display" class="lives"></div>
                <div id="coins-display" class="coins"
                    style="font-size: 20px; font-weight: 900; background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px; color: #F59E0B; margin-left: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    üí∞ <span id="game-coin-count">0</span></div>
                <div id="timer-display" class="coins"
                    style="font-size: 20px; font-weight: 900; background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px; color: #EF4444; margin-left: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid #FCA5A5;">
                    ‚è±Ô∏è <span id="time-left"></span>
                </div>
                <div class="progress-bar">
                    <div id="progress-bar-inner"></div>
                </div>
                <div class="top-buttons"><button id="mute-btn" class="btn icon-btn" title="ËÅ≤Èü≥ÂàáÊèõ">üîä</button><button
                        id="quit-level-btn" class="btn icon-btn" title="ÊîæÊ£Ñ‰ªªÂãô">‚Ü©Ô∏è</button></div>
            </div>
            <div class="quiz-content">
                <div id="combo-display"></div>
                <img id="question-image" src=""
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div id="question-image-fallback"
                    style="display:none; font-size:clamp(80px,18vw,110px); justify-content:center; align-items:center; height:160px;">
                </div>
                <div id="interaction-area">
                    <div id="answer-hint-card"></div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                        <button id="speech-btn" class="speech-btn" title="ËÅÜËÅΩÁôºÈü≥">üì¢</button>
                        <button id="voice-btn" class="voice-btn" title="Ë™ûÈü≥Ëæ®Ë≠ò">üé§</button>
                    </div>
                    <div id="char-display"></div>
                    <div id="bopomofo-answer"></div>
                </div>
                <div id="feedback-message"></div>
            </div>
            <div class="keyboard">
                <div class="bopomofo-group" id="consonants"></div>
                <div class="bopomofo-group" id="vowels"></div>
                <div class="bopomofo-group" id="tones"></div>
                <div class="keyboard-controls">
                    <button id="hint-btn" class="btn hint-btn">üí° ÊèêÁ§∫: 1</button>
                    <button id="clear-btn" class="btn control-btn clear-btn">üóëÔ∏è Ê∏ÖÈô§</button>
                    <button id="check-btn" class="btn control-btn check-btn">üëâ ÈÄÅÂá∫‰ΩúÁ≠î</button>
                </div>
            </div>
        </div>
        <div id="level-end-screen" class="screen">
            <h2 id="level-end-title"></h2>
            <div id="level-end-hearts"><span class="heart">ü§ç</span><span class="heart">ü§ç</span><span
                    class="heart">ü§ç</span></div>
            <p id="level-end-message"></p>
            <div id="score-display" style="display:none;"></div>
            <div id="leaderboard-panel" class="leaderboard-panel" style="display:none;">
                <div class="leaderboard-title">üèÜ Êú¨Âú∞ÊéíË°åÊ¶ú (Ââç‰∫î)</div>
                <div id="leaderboard-list"></div>
            </div>
            <button id="review-btn" class="btn">Â≠∏ÁøíÂõûÈ°ß</button>
        </div>
        <div id="level-review-screen" class="screen">
            <h2>Êú¨ÈóúÂõûÈ°ß</h2>
            <div id="review-items-container"></div>
            <div><button id="retry-level-btn" class="btn">ÂÜçÁé©‰∏ÄÊ¨°</button><button id="next-level-btn"
                    class="btn">‰∏ã‰∏ÄÈóú</button><button id="back-to-map-btn" class="btn">ÂõûÂú∞Âúñ</button></div>
        </div>

        <!-- ÂÆ∂Èï∑ÂæåÂè∞‰ªãÈù¢ -->
        <div id="parent-dashboard" class="screen scrollable-screen">
            <h2>‚öôÔ∏è ÂÆ∂Èï∑Ê®°ÂºèÔºöËá™Ë®ÇÈ°åÂ∫´</h2>
            <div class="form-group">
                <label>Êñ∞Â¢ûÈ°åÁõÆ (ÂúãÂ≠ó)</label>
                <input type="text" id="custom-char" class="form-input" placeholder="‰æãÂ¶ÇÔºöËòã">
            </div>
            <div class="form-group">
                <label>Ê≥®Èü≥ (‰æãÂ¶ÇÔºö„ÑÜ„Ñß„Ñ•Àä)</label>
                <input type="text" id="custom-bopomofo" class="form-input" placeholder="Â∞èÊíáÊ≠•ÔºöËÅ≤Ë™øÂØ´Âú®ÊúÄÂæå">
            </div>
            <button id="add-custom-btn" class="btn" style="background-color: #6BCB77;">‚ûï Âä†ÂÖ•È°åÂ∫´</button>

            <div id="custom-pool-list"></div>

            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                <button id="share-qr-btn" class="btn" style="background-color: #4D96FF;">üì± ÁîüÊàê QR</button>
                <button id="upload-cloud-btn" class="btn" style="background-color: #F97316;">‚òÅÔ∏è ‰∏äÊû∂Èõ≤Á´Ø</button>
                <button id="view-market-btn" class="btn" style="background-color: #818CF8;">üõí ÁÄèË¶ΩÂ∏ÇÈõÜ</button>
                <button id="close-parent-btn" class="btn">ËøîÂõûÈÅäÊà≤</button>
            </div>

            <h4 style="margin-top:25px;">üìâ Â≠∏ÁøíÊàêÈï∑ÂàÜÊûê</h4>
            <div id="radar-chart-container">
                <canvas id="radar-canvas" width="300" height="300"></canvas>
                <p id="radar-empty-msg" style="color:#64748b; font-size:14px; display:none;">ÈÇÑÊ≤íÊúâË∂≥Â§†ÁöÑÁ∑¥ÁøíÊï∏ÊìöÂñîÔºÅ</p>
            </div>

            <h4 style="margin-top:25px;">üé§ Áµ¶ÂØ∂Ë≤ùÁöÑÈºìÂãµË™ûÈü≥</h4>
            <div
                style="background: rgba(255,255,255,0.5); padding: 15px; border-radius: 16px; display: flex; align-items: center; gap: 10px;">
                <button id="record-btn" class="btn" style="background-color: #EF4444; flex: 1;">üî¥ ÈñãÂßãÈåÑÈü≥</button>
                <button id="play-record-btn" class="btn" style="background-color: #6BCB77; flex: 1; display: none;">‚ñ∂Ô∏è
                    Ë©¶ËÅΩ</button>
            </div>
            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">ÈåÑË£Ω‰∏ÄÊÆµÈºìÂãµÁöÑË©±ÔºåÁï∂Â≠©Â≠êÈÄöÈóúÊàêÂäüÊôÇÊúÉÊí≠ÊîæÂñîÔºÅ</p>
            <button id="export-report-btn" class="btn"
                style="background-color: #818CF8; width: 100%; margin-top: 15px;">üìä ÂåØÂá∫Â≠∏ÁøíÂ†±Âëä</button>
        </div>

        <!-- QR È°ØÁ§∫ÈÅÆÁΩ© -->
        <div id="qr-overlay" class="qr-overlay">
            <h3>üì± ÊéÉÊèè QR Á¢ºÂåØÂÖ•È°åÂ∫´</h3>
            <div id="qrcode"></div>
            <p>Ë´ãÁî®Âè¶‰∏ÄÂè∞Ë£ùÁΩÆÊéÉÊèèÊ≠§Á¢º</p>
            <button id="close-qr-btn" class="btn">ÈóúÈñâ</button>
        </div>

        <!-- Èõ≤Á´ØÂ∏ÇÈõÜÈÅÆÁΩ© (v3.0) -->
        <div id="cloud-market-overlay" class="qr-overlay" style="display: none;">
            <h3>üå©Ô∏è Èõ≤Á´ØÈ°åÂ∫´Â∏ÇÈõÜ</h3>
            <div class="clay-card" style="width: 100%; max-width: 500px; padding: 20px; margin-bottom: 20px;">
                <h4 style="margin-top:0; color:var(--primary-color);">üîë ‰ª£Á¢º‰∏ÄÈçµÁç≤Âèñ</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="market-code-input" placeholder="Ëº∏ÂÖ• 6 ‰ΩçÊï∏‰ª£Á¢º" maxlength="6"
                        style="flex: 1; padding: 12px; border-radius: 12px; border: 2px solid var(--secondary-color); font-size: 18px; text-align: center;">
                    <button id="import-code-btn" class="btn"
                        style="margin:0; background:var(--primary-color);">Áç≤Âèñ</button>
                </div>
                <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 20px 0;">
                <h4 style="color:var(--secondary-color);">üî• ÊúÄÊñ∞ÁÜ±ÈñÄÈ°åÂ∫´</h4>
                <div id="market-list"
                    style="max-height: 350px; overflow-y: auto; width: 100%; padding: 10px; background: #f8fafc; border-radius: 20px;">
                    <p style="text-align: center; color: #64748b;">Ê≠£Âú®ÈÄ£Á∑öËá≥Èõ≤Á´Ø...</p>
                </div>
            </div>
            <button id="close-market-btn" class="btn" style="background: #64748b;">ÈóúÈñâÂ∏ÇÈõÜ</button>
        </div>

        <!-- Â§ö‰∫∫Á´∂Ë≥ΩÈñãÊàø/Âä†ÂÖ•ÈÅÆÁΩ© (v3.0) -->
        <div id="multiplayer-overlay" class="qr-overlay" style="display: none;">
            <h3>üè´ Â§ö‰∫∫Á´∂Ë≥Ω</h3>
            <div id="multiplayer-setup" style="width: 100%; max-width: 400px;">
                <div class="clay-card" style="margin-bottom: 25px; border-top: 8px solid var(--accent-color);">
                    <h4 style="margin-top:0; color:var(--accent-color);">ÊïôÂ∏´ÈñãÊàø</h4>
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 20px;">Âª∫Á´ãÊàøÈñìÂæåÔºåËÆìÂ≠∏ÁîüËº∏ÂÖ•ÊàøÈñìÁ¢ºÊàñÊéÉÁ¢ºÂä†ÂÖ•„ÄÇ</p>
                    <button id="create-room-btn" class="btn"
                        style="background: var(--accent-color); width: 100%; margin:0;">‚ú® ÈñãÂâµÊàøÈñì</button>
                </div>
                <div class="clay-card" style="border-top: 8px solid var(--primary-color);">
                    <h4 style="margin-top:0; color:var(--primary-color);">Â≠∏ÁîüÂä†ÂÖ•</h4>
                    <input type="text" id="room-id-input" placeholder="ÊàøÈñìÁ¢º (6‰ΩçÊï∏)" maxlength="6"
                        style="width: 100%; padding: 15px; border-radius: 15px; border: 3px solid var(--secondary-color); margin-bottom: 15px; font-size: 20px; text-align: center; background: #f8fafc;">
                    <button id="join-room-btn" class="btn" style="width: 100%; margin:0;">üöÄ ÈÄ≤ÂÖ•Á´∂Ë≥Ω</button>
                </div>
            </div>
            <div id="lobby-view" style="display: none; width: 100%; max-width: 400px;">
                <div class="clay-card">
                    <h4 style="margin-top:0;">Â§ßÂª≥ÂæÖÂëΩ‰∏≠ÂøÉ</h4>
                    <div style="text-align:center;">
                        <span class="room-code-badge" id="display-room-id">------</span>
                        <p style="color: #64748b; font-size: 14px;">Ë´ãÈÇÄË´ãÂ§ßÂÆ∂‰ΩøÁî®Ê≠§ÊàøÈñìÁ¢ºÂä†ÂÖ•</p>
                    </div>
                    <div style="background: #f1f5f9; border-radius: 20px; padding: 15px; margin: 15px 0;">
                        <p style="text-align: left; font-weight: 700; margin-top: 0;">Â∑≤Âä†ÂÖ•ÊàêÂì°Ôºö</p>
                        <div id="player-list" style="max-height: 250px; overflow-y: auto; padding-right: 5px;"></div>
                    </div>
                    <button id="start-multiplayer-game-btn" class="btn"
                        style="display: none; background: var(--accent-color); width: 100%; margin: 10px 0 0 0;">üèÅ
                        ÂÖ®Âì°Âá∫ÁôºÔºÅ</button>
                </div>
            </div>
            <button id="close-multiplayer-btn" class="btn"
                style="margin-top: 30px; background: #64748b; font-size: 16px; padding: 8px 20px;">ËøîÂõûÈ¶ñÈ†Å</button>
        </div>

        <!-- Ëá™ÂÆöÁæ©Á¢∫Ë™ç Modal (v3.0.1) -->
        <div id="confirm-modal-overlay">
            <div class="confirm-modal-card">
                <div class="confirm-modal-title" id="confirm-title">‚ùì Á¢∫ÂÆöÂóéÔºü</div>
                <div class="confirm-modal-text" id="confirm-text">Á¢∫ÂÆöË¶ÅÂü∑Ë°åÊ≠§Êìç‰ΩúÂóéÔºü</div>
                <div class="confirm-modal-btns">
                    <button class="btn" id="confirm-cancel" style="background: #94a3b8;">ÂèñÊ∂à</button>
                    <button class="btn" id="confirm-ok" style="background: var(--accent-color);">Á¢∫ÂÆö</button>
                </div>
            </div>
        </div>

        <!-- ÂÆ∂Èï∑ÁÆóË°ìÈéñ -->
        <div id="parent-lock-overlay">
            <div class="parent-lock-card">
                <div style="font-size: 40px;">üîê</div>
                <h2>ÂÆ∂Èï∑È©óË≠â</h2>
                <p>Ë´ãËº∏ÂÖ•Ê≠£Á¢∫Á≠îÊ°à‰ª•Ëß£Èéñ</p>
                <div id="lock-question">12 + 5 = ?</div>
                <input type="number" id="lock-input" placeholder="Á≠îÊ°à" inputmode="numeric">
                <div style="display: flex; gap: 10px;">
                    <button id="lock-cancel-btn" class="btn" style="flex:1;">ÂèñÊ∂à</button>
                    <button id="lock-confirm-btn" class="btn"
                        style="background-color: var(--accent-color); flex:1; color:white;">Á¢∫Ë™ç</button>
                </div>
            </div>
        </div>

        <!-- Ë≠∑ÁúºÊèêÁ§∫ -->
        <div id="health-alert-overlay">
            <div class="health-icon">üå≥</div>
            <h1>ËÆìÁúºÁùõ‰ºëÊÅØ‰∏Ä‰∏ãÂêßÔºÅ</h1>
            <p style="font-size: 18px;">Â∑≤Á∂ìÈÄ£Á∫åÊåëÊà∞ 20 ÂàÜÈêòÂõâÔºå<br>ÁúãÂêëÈÅ†ÊñπÁöÑËçâÂú∞ÊàñÂ§©Á©∫ÊîæÈ¨Ü‰∏Ä‰∏ãÂêß„ÄÇ</p>
            <div id="health-timer">Ââ©È§òÊôÇÈñìÔºö20 Áßí</div>
        </div>
        <!-- ÂêâÁ••Áâ©ËàáÂ∞çË©±Ê°Ü (v3.2.0) -->
        <div id="mascot-container" class="mascot-idle">
            <div id="mascot-bubble" class="mascot-bubble">Âä†Ê≤πÂä†Ê≤πÔºÅ</div>
            <svg id="mascot-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Âô¥ÁÅ´ÈæçË∫´ËªÄ -->
                <path id="mascot-body" d="M40,140 Q40,60 100,60 Q160,60 160,140 L160,160 Q100,180 40,160 Z"
                    fill="#6BCB77" stroke="#4DAF50" stroke-width="4" />
                <!-- ËÇöÂ≠ê -->
                <ellipse cx="100" cy="120" rx="40" ry="50" fill="#C1E9C1" />
                <!-- ÁúºÁùõ -->
                <g id="mascot-eyes">
                    <circle id="eye-l" cx="75" cy="95" r="8" fill="white" />
                    <circle id="eye-r" cx="125" cy="95" r="8" fill="white" />
                    <circle cx="75" cy="95" r="4" fill="#1E1B4B" />
                    <circle cx="125" cy="95" r="4" fill="#1E1B4B" />
                </g>
                <!-- ËÖÆÁ¥Ö -->
                <circle cx="60" cy="115" r="6" fill="#FFB6C1" opacity="0.6" />
                <circle cx="140" cy="115" r="6" fill="#FFB6C1" opacity="0.6" />
                <!-- Âò¥Â∑¥ -->
                <path id="mascot-mouth" d="M85,130 Q100,140 115,130" fill="none" stroke="#1E1B4B" stroke-width="3"
                    stroke-linecap="round" />
                <!-- ÈæçËßí -->
                <path d="M70,65 Q60,40 50,55" fill="#FFD93D" stroke="#D97706" stroke-width="2" />
                <path d="M130,65 Q140,40 150,55" fill="#FFD93D" stroke="#D97706" stroke-width="2" />
            </svg>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from './firebase-config.js';

        // ÂàùÂßãÂåñ Firebase (ÂÉÖÂú®Êúâ API Key ÊôÇÂü∑Ë°å)
        if (firebaseConfig && firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // ÂåøÂêçÁôªÂÖ• (Á¢∫‰øùËÉΩËÆÄÂØ´ Firestore)
            auth.signInAnonymously().catch((error) => {
                console.error("Firebase ÁôªÂÖ•Â§±Êïó:", error);
            });

            // Êö¥Èú≤Áµ¶ÂÖ®Âüü‰ª•Âà©ËàäÊúâËÖ≥Êú¨Ë™øÁî®
            window.fbDB = db;
            window.fbAuth = auth;
        } else {
            console.warn("‚ö†Ô∏è Êú¨Âú∞Áí∞Â¢ÉÊú™ÂÅµÊ∏¨Âà∞ Firebase API KeyÔºåÂ∑≤ÈÄ≤ÂÖ•Èõ¢Á∑öÊ®°Âºè„ÄÇÈõ≤Á´ØÂäüËÉΩÂ∞áÁÑ°Ê≥ï‰ΩøÁî®Ôºå‰ΩÜË™ûÈü≥ËàáÈõ∑ÈÅîÂúñÂäüËÉΩÊ≠£Â∏∏„ÄÇ");
            window.fbDB = null;
            window.fbAuth = null;
        }

        // --- „ÄêÊ†∏ÂøÉÂ≠òÂÑ≤ÂçáÁ¥ö„ÄëIndexedDB ÂºïÊìé (v3.1) ---
        class ZhuyinDB {
            constructor() {
                this.dbName = 'ZhuyinChallengeDB';
                this.version = 2;
                this.db = null;
            }
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
                        if (!db.objectStoreNames.contains('customPool')) db.createObjectStore('customPool');
                        if (!db.objectStoreNames.contains('stats')) db.createObjectStore('stats');
                        if (!db.objectStoreNames.contains('media')) db.createObjectStore('media');
                    };
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            async get(store, key) {
                if (!this.db) await this.init();
                return new Promise((resolve) => {
                    const tx = this.db.transaction(store, 'readonly');
                    const request = tx.objectStore(store).get(key);
                    request.onsuccess = () => resolve(request.result);
                });
            }
            async set(store, key, val) {
                if (!this.db) await this.init();
                return new Promise((resolve) => {
                    const tx = this.db.transaction(store, 'readwrite');
                    tx.objectStore(store).put(val, key);
                    tx.oncomplete = () => resolve();
                });
            }
        }
        window.storage = new ZhuyinDB();

        async function initStorageAndMigrate() {
            await window.storage.init();
            const legacyState = localStorage.getItem('bopomofoPartyState');
            if (legacyState && !await window.storage.get('settings', 'gameState')) {
                console.log("üì¶ ÁôºÁèæËàäÊúâÊï∏ÊìöÔºåÊ≠£Âú®ÈÅ∑ÁßªËá≥ IndexedDB...");
                await window.storage.set('settings', 'gameState', JSON.parse(legacyState));
                const legacyPool = localStorage.getItem('bopomofoCustomPool');
                if (legacyPool) await window.storage.set('customPool', 'main', JSON.parse(legacyPool));
                const legacyStats = localStorage.getItem('bopomofoStats');
                if (legacyStats) await window.storage.set('stats', 'main', JSON.parse(legacyStats));
                console.log("‚úÖ Êï∏ÊìöÈÅ∑ÁßªÂÆåÊàêÔºÅ");
            }
        }
        let gameState = { unlockedLevels: 1, hearts: {}, achievements: [], coins: 0, equipped: {} };
        let bopomofoStats = {};
        let customPool = [];

        // ÂàùÂßãÂåñÂÑ≤Â≠òÂºïÊìé (UI Êõ¥Êñ∞ÈÇèËºØÁßªËá≥ DOMContentLoaded)
        const storageReady = initStorageAndMigrate();

        // --- „ÄêÊ†∏ÂøÉÂçáÁ¥ö„ÄëÊì¥ÂÖÖÈ°åÂ∫´ ---
        const gameLevels = [
            // --- ÂéüÊúâÈóúÂç°Êì¥ÂÖÖ ---
            {
                name: "Ê∞¥Êûú", icon: "üçé", questions: [
                    { char: 'Ëòã', bopomofo: '„ÑÜ„Ñß„Ñ•Àä', image: './assets/images/apple.png' }, { char: 'Ëïâ', bopomofo: '„Ñê„Ñß„Ñ†', image: './assets/images/banana.png' }, { char: 'Áìú', bopomofo: '„Ñç„Ñ®„Ñö', image: './assets/images/watermelon.png' }, { char: 'Ëéì', bopomofo: '„Ñá„ÑüÀä', image: './assets/images/strawberry.png' }, { char: 'Ê°É', bopomofo: '„Ñä„Ñ†Àä', image: './assets/images/peach.png' }, { char: 'ËêÑ', bopomofo: '„Ñä„Ñ†Àä', image: './assets/images/grapes.png' }, { char: 'Ê©ò', bopomofo: '„Ñê„Ñ©Àä', emoji: 'üçä' }, { char: 'Ê¢®', bopomofo: '„Ñå„ÑßÀä', image: './assets/images/pear.png' }, { char: 'Ê™¨', bopomofo: '„Ñá„Ñ•Àä', emoji: 'üçã' },
                    // Êñ∞Â¢û
                    { char: 'È≥≥', bopomofo: '„Ñà„Ñ•Àã', emoji: 'üçç' }, { char: 'Ëä≠', bopomofo: '„ÑÖ„Ñö', emoji: 'üçê' }, { char: 'Ëäí', bopomofo: '„Ñá„Ñ§Àä', emoji: 'ü•≠' }
                ]
            },
            {
                name: "ÂãïÁâ©", icon: "üê∂", questions: [
                    { char: 'Ë≤ì', bopomofo: '„Ñá„Ñ†', image: './assets/images/cat.png' }, { char: 'Áãó', bopomofo: '„Ñç„Ñ°Àá', image: './assets/images/dog.png' }, { char: 'ÂÖî', bopomofo: '„Ñä„Ñ®Àã', image: './assets/images/rabbit.png' }, { char: 'È≠ö', bopomofo: '„Ñ©Àä', image: './assets/images/fish.png' }, { char: 'ÁÜä', bopomofo: '„Ñí„Ñ©„Ñ•Àä', image: './assets/images/teddy-bear.png' }, { char: 'Ëôé', bopomofo: '„Ñè„Ñ®Àá', emoji: 'üêØ' }, { char: 'ÁçÖ', bopomofo: '„Ñï', image: './assets/images/lion.png' }, { char: 'Ë±°', bopomofo: '„Ñí„Ñß„Ñ§Àã', image: './assets/images/elephant.png' }, { char: 'Áå¥', bopomofo: '„Ñè„Ñ°Àä', emoji: 'üêí' }, { char: 'È≥•', bopomofo: '„Ñã„Ñß„Ñ†Àá', image: './assets/images/bird.png' },
                    // Êñ∞Â¢û
                    { char: 'Áâõ', bopomofo: '„Ñã„Ñß„Ñ°Àä', emoji: 'üêÆ' }, { char: 'Áæä', bopomofo: '„Ñß„Ñ§Àä', emoji: 'üêë' }, { char: 'È¶¨', bopomofo: '„Ñá„ÑöÀá', emoji: 'üê¥' }, { char: 'Ë±¨', bopomofo: '„Ñì„Ñ®', emoji: 'üê∑' }, { char: 'È¥®', bopomofo: '„Ñß„Ñö', emoji: 'ü¶Ü' }
                ]
            },
            { name: "‰∫§ÈÄö", icon: "üöó", questions: [{ char: 'Ëªä', bopomofo: '„Ñî„Ñú', image: './assets/images/car.png' }, { char: 'Ëàπ', bopomofo: '„Ñî„Ñ®„Ñ¢Àä', emoji: 'üö¢' }, { char: 'Ê©ü', bopomofo: '„Ñê„Ñß', image: './assets/images/airplane.png' }, { char: 'ÁÅ´', bopomofo: '„Ñè„Ñ®„ÑõÀá', image: './assets/images/train.png' }, { char: 'ÂñÆ', bopomofo: '„Ñâ„Ñ¢', image: './assets/images/bicycle.png' }, { char: 'ÂÖ¨', bopomofo: '„Ñç„Ñ®„Ñ•', image: './assets/images/bus.png' }, { char: 'Âç°', bopomofo: '„Ñé„ÑöÀá', image: './assets/images/truck.png' }] },
            { name: "Ë∫´È´î", icon: "‚úã", questions: [{ char: 'È†≠', bopomofo: '„Ñä„Ñ°Àä', image: './assets/images/head.png' }, { char: 'Êâã', bopomofo: '„Ñï„Ñ°Àá', image: './assets/images/hand.png' }, { char: 'ËÖ≥', bopomofo: '„Ñê„Ñß„Ñ†Àá', emoji: 'ü¶∂' }, { char: 'Áúº', bopomofo: '„Ñß„Ñ¢Àá', image: './assets/images/visible.png' }, { char: 'Âè£', bopomofo: '„Ñé„Ñ°Àá', image: './assets/images/mouth.png' }, { char: 'Èºª', bopomofo: '„ÑÖ„ÑßÀä', emoji: 'üëÉ' }, { char: 'ËÄ≥', bopomofo: '„Ñ¶Àá', emoji: 'üëÇ' }] },
            { name: "ÂÆ∂‰∫∫", icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", questions: [{ char: 'Áà∏', bopomofo: '„ÑÖ„ÑöÀã', image: './assets/images/father.png' }, { char: 'Â™Ω', bopomofo: '„Ñá„Ñö', image: './assets/images/mother.png' }, { char: 'Âì•', bopomofo: '„Ñç„Ñú', image: './assets/images/boy.png' }, { char: 'Âßê', bopomofo: '„Ñê„Ñß„ÑùÀá', image: './assets/images/girl.png' }, { char: 'Âºü', bopomofo: '„Ñâ„ÑßÀã', emoji: 'üë¶' }, { char: 'Â¶π', bopomofo: '„Ñá„ÑüÀã', emoji: 'üëß' }, { char: 'Áà∫', bopomofo: '„Ñß„ÑùÀä', emoji: 'üë¥' }] },
            { name: "Â≠∏Ê†°", icon: "üè´", questions: [{ char: 'Êõ∏', bopomofo: '„Ñï„Ñ®', image: './assets/images/book.png' }, { char: 'Á≠Ü', bopomofo: '„ÑÖ„ÑßÀá', image: './assets/images/pen.png' }, { char: 'Â∞∫', bopomofo: '„ÑîÀá', image: './assets/images/ruler.png' }, { char: 'Ê°å', bopomofo: '„Ñì„Ñ®„Ñõ', emoji: 'ü™ë' }, { char: 'Ê§Ö', bopomofo: '„ÑßÀá', emoji: 'ü™ë' }, { char: 'Ááà', bopomofo: '„Ñâ„Ñ•', emoji: 'üí°' }, { char: 'ÈñÄ', bopomofo: '„Ñá„Ñ£Àä', image: './assets/images/door.png' }] },
            { name: "È°èËâ≤", icon: "üé®", questions: [{ char: 'Á¥Ö', bopomofo: '„Ñè„Ñ®„Ñ•Àä', image: './assets/images/red.png' }, { char: 'ÈªÉ', bopomofo: '„Ñè„Ñ®„Ñ§Àä', image: './assets/images/yellow.png' }, { char: 'Ëóç', bopomofo: '„Ñå„Ñ¢Àä', image: './assets/images/blue.png' }, { char: 'Á∂†', bopomofo: '„Ñå„Ñ©Àã', image: './assets/images/green.png' }, { char: 'ÁôΩ', bopomofo: '„ÑÖ„ÑûÀä', image: './assets/images/white.png' }, { char: 'Èªë', bopomofo: '„Ñè„Ñü', image: './assets/images/black.png' }] },
            { name: "Â§©Ê∞£", icon: "‚õÖ", questions: [{ char: 'Êô¥', bopomofo: '„Ñë„Ñß„Ñ•Àä', image: './assets/images/sunny.png' }, { char: 'Èõ®', bopomofo: '„Ñ©Àá', image: './assets/images/rain.png' }, { char: 'Èõ≤', bopomofo: '„Ñ©„Ñ£Àä', emoji: '‚òÅÔ∏è' }, { char: 'Èõ™', bopomofo: '„Ñí„Ñ©„ÑùÀá', image: './assets/images/snow.png' }, { char: 'È¢®', bopomofo: '„Ñà„Ñ•', image: './assets/images/wind.png' }, { char: 'Èõ∑', bopomofo: '„Ñå„ÑüÀä', image: './assets/images/storm.png' }, { char: 'Ëôπ', bopomofo: '„Ñè„Ñ®„Ñ•Àä', image: './assets/images/rainbow.png' }] },
            { name: "ÂΩ¢ÁãÄ", icon: "üî∫", questions: [{ char: 'Âúì', bopomofo: '„Ñ©„Ñ¢Àä', emoji: '‚≠ï' }, { char: 'Êñπ', bopomofo: '„Ñà„Ñ§', image: './assets/images/square.png' }, { char: 'Ëßí', bopomofo: '„Ñê„Ñß„Ñ†Àá', image: './assets/images/triangle.png' }, { char: 'Êòü', bopomofo: '„Ñí„Ñß„Ñ•', image: './assets/images/star.png' }, { char: 'ÂøÉ', bopomofo: '„Ñí„Ñß„Ñ£', image: './assets/images/heart.png' }] },
            { name: "È£üÁâ©", icon: "üçî", questions: [{ char: 'È£Ø', bopomofo: '„Ñà„Ñ¢Àã', image: './assets/images/rice.png' }, { char: 'È∫µ', bopomofo: '„Ñá„Ñß„Ñ¢Àã', emoji: 'üçú' }, { char: 'Ëõã', bopomofo: '„Ñâ„Ñ¢Àã', image: './assets/images/egg.png' }, { char: 'ËÇâ', bopomofo: '„Ññ„Ñ°Àã', emoji: 'ü•©' }, { char: 'Ëèú', bopomofo: '„Ñò„ÑûÀã', image: './assets/images/vegetable.png' }, { char: 'ÊπØ', bopomofo: '„Ñä„Ñ§', emoji: 'ü•£' }, { char: 'Á≥ñ', bopomofo: '„Ñä„Ñ§Àä', emoji: 'üç¨' }] },

            // --- ÂÖ®Êñ∞ÈóúÂç°Êì¥ÂÖÖ ---
            { name: "Ëá™ÁÑ∂", icon: "üå≥", questions: [{ char: 'Â±±', bopomofo: '„Ñï„Ñ¢', emoji: '‚õ∞Ô∏è' }, { char: 'Êµ∑', bopomofo: '„Ñè„ÑûÀá', emoji: 'üåä' }, { char: 'Ëä±', bopomofo: '„Ñè„Ñ®„Ñö', emoji: 'üå∏' }, { char: 'Ëçâ', bopomofo: '„Ñò„Ñ†Àá', emoji: 'üåø' }, { char: 'Ê®π', bopomofo: '„Ñï„Ñ®Àã', emoji: 'üå≥' }, { char: 'Áü≥', bopomofo: '„ÑïÀä', emoji: 'ü™®' }, { char: 'Êòü', bopomofo: '„Ñí„Ñß„Ñ•', emoji: '‚≠ê' }] },
            { name: "ÊòÜËü≤", icon: "ü¶ã", questions: [{ char: 'Ëù∂', bopomofo: '„Ñâ„Ñß„ÑùÀä', emoji: 'ü¶ã' }, { char: 'ËúÇ', bopomofo: '„Ñà„Ñ•', emoji: 'üêù' }, { char: 'Ëüª', bopomofo: '„ÑßÀá', emoji: 'üêú' }, { char: 'Ëöä', bopomofo: '„Ñ®„Ñ£Àä', emoji: 'ü¶ü' }, { char: 'Ëü≤', bopomofo: '„Ñî„Ñ®„Ñ•Àä', emoji: 'üêõ' }, { char: 'Ëõõ', bopomofo: '„Ñì„Ñ®', emoji: 'üï∑Ô∏è' }] },
            { name: "Âãï‰Ωú", icon: "üèÉ", questions: [{ char: 'Ë∑ë', bopomofo: '„ÑÜ„Ñ†Àá', emoji: 'üèÉ' }, { char: 'Ë∑≥', bopomofo: '„Ñä„Ñß„Ñ†Àã', emoji: 'ü¶ò' }, { char: 'Ëµ∞', bopomofo: '„Ñó„Ñ°Àá', emoji: 'üö∂' }, { char: 'È£õ', bopomofo: '„Ñà„Ñü', emoji: 'ü¶Ö' }, { char: 'Ê∏∏', bopomofo: '„Ñß„Ñ°Àä', emoji: 'üèä' }, { char: 'Á¨ë', bopomofo: '„Ñí„Ñß„Ñ†Àã', emoji: 'üòÑ' }, { char: 'Âì≠', bopomofo: '„Ñé„Ñ®', emoji: 'üò≠' }] },
            { name: "Êó•Â∏∏", icon: "üè†", questions: [{ char: 'Â∫ä', bopomofo: '„Ñî„Ñ®„Ñ§Àä', emoji: 'üõèÔ∏è' }, { char: 'ÊùØ', bopomofo: '„ÑÖ„Ñü', emoji: 'ü•§' }, { char: 'Á¢ó', bopomofo: '„Ñ®„Ñ¢Àá', emoji: 'ü•£' }, { char: 'Èûã', bopomofo: '„Ñí„Ñß„ÑùÀä', emoji: 'üëü' }, { char: 'Ë°£', bopomofo: '„Ñß', emoji: 'üëï' }, { char: 'Ë§≤', bopomofo: '„Ñé„Ñ®Àã', emoji: 'üëñ' }, { char: 'Èêò', bopomofo: '„Ñì„Ñ®„Ñ•', emoji: '‚è∞' }] }
        ];
        const shopItems = [
            { id: 'hat-cap', name: 'È¥®ËàåÂ∏Ω', price: 10, type: 'hat', emoji: 'üß¢' },
            { id: 'hat-crown', name: 'ÁöáÂÜ†', price: 50, type: 'hat', emoji: 'üëë' },
            { id: 'hat-grad', name: 'Â≠∏Â£´Â∏Ω', price: 30, type: 'hat', emoji: 'üéì' },
            { id: 'hat-party', name: 'Ê¥æÂ∞çÂ∏Ω', price: 15, type: 'hat', emoji: 'ü•≥' },
            { id: 'hat-cowboy', name: 'Áâõ‰ªîÂ∏Ω', price: 40, type: 'hat', emoji: 'ü§†' },
            { id: 'hat-magic', name: 'È≠îÊ≥ïÂ∏Ω', price: 80, type: 'hat', emoji: 'üßô' }
        ];

        const bopomofoParts = { consonants: ['„ÑÖ', '„ÑÜ', '„Ñá', '„Ñà', '„Ñâ', '„Ñä', '„Ñã', '„Ñå', '„Ñç', '„Ñé', '„Ñè', '„Ñê', '„Ñë', '„Ñí', '„Ñì', '„Ñî', '„Ñï', '„Ññ', '„Ñó', '„Ñò', '„Ñô'], medials: ['„Ñß', '„Ñ®', '„Ñ©'], finals: ['„Ñö', '„Ñõ', '„Ñú', '„Ñù', '„Ñû', '„Ñü', '„Ñ†', '„Ñ°', '„Ñ¢', '„Ñ£', '„Ñ§', '„Ñ•', '„Ñ¶'], tones: ['Àä', 'Àá', 'Àã', 'Àô'] };
        const topSideConsonants = ['„ÑÖ', '„ÑÜ', '„Ñá', '„Ñà', '„Ñâ', '„Ñä', '„Ñã', '„Ñå', '„Ñç', '„Ñé', '„Ñè']; const specialStackConsonants = ['„Ñê', '„Ñë', '„Ñí']; const allVowelsForButtons = [...new Set([...bopomofoParts.medials, ...bopomofoParts.finals])];

        document.addEventListener('DOMContentLoaded', () => {
            const screens = { start: document.getElementById('start-screen'), levelSelect: document.getElementById('level-select-screen'), game: document.getElementById('game-screen'), levelEnd: document.getElementById('level-end-screen'), levelReview: document.getElementById('level-review-screen'), achievements: document.getElementById('achievements-screen'), parentDashboard: document.getElementById('parent-dashboard') };
            const interactionArea = document.getElementById('interaction-area'); const livesDisplay = document.getElementById('lives-display'); const progressBarInner = document.getElementById('progress-bar-inner'); const questionImage = document.getElementById('question-image'); const questionImageFallback = document.getElementById('question-image-fallback'); const charDisplay = document.getElementById('char-display'); const bopomofoAnswer = document.getElementById('bopomofo-answer'); const feedbackMessage = document.getElementById('feedback-message'); const answerHintCard = document.getElementById('answer-hint-card'); const levelSelectContainer = document.getElementById('level-buttons-container'); const resetButton = document.getElementById('reset-progress-btn'); const reviewBtn = document.getElementById('review-btn'); const reviewContainer = document.getElementById('review-items-container'); const muteBtn = document.getElementById('mute-btn'); const timerDisplay = document.getElementById('timer-display'); const timeLeftSpan = document.getElementById('time-left');

            // --- Ë£úÈΩäÁº∫Â§±ÁöÑ DOM ÂèÉËÄÉ ---
            const achievementsBtn = document.getElementById('achievements-btn');
            const backToStartBtn = document.getElementById('back-to-start-btn');
            const hintBtn = document.getElementById('hint-btn');
            const speechBtn = document.getElementById('speech-btn');
            const comboDisplay = document.getElementById('combo-display');
            const achievementsContainer = document.getElementById('achievements-container');

            // Áï∞Ê≠•Âä†ËºâÊâÄÊúâÊï∏Êìö‰∏¶Êõ¥Êñ∞ UI (‰øÆÂæ© Scope ÂïèÈ°å)
            async function loadAllData() {
                gameState = await window.storage.get('settings', 'gameState') || { unlockedLevels: 1, hearts: {}, achievements: [], coins: 0, equipped: {} };
                if (gameState.coins === undefined) gameState.coins = 0;
                if (!gameState.equipped) gameState.equipped = {};

                customPool = await window.storage.get('customPool', 'main') || [];
                bopomofoStats = await window.storage.get('stats', 'main') || {};

                // Achievements 2.0: Login Streak Tracking
                const today = new Date().toLocaleDateString();
                if (bopomofoStats.lastLoginDate !== today) {
                    if (bopomofoStats.lastLoginDate) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (bopomofoStats.lastLoginDate === yesterday.toLocaleDateString()) {
                            bopomofoStats.loginStreak = (bopomofoStats.loginStreak || 0) + 1;
                        } else {
                            bopomofoStats.loginStreak = 1;
                        }
                    } else {
                        bopomofoStats.loginStreak = 1;
                    }
                    bopomofoStats.lastLoginDate = today;
                    await window.storage.set('stats', 'main', bopomofoStats);
                }

                updateLevelSelectScreen();
                renderAchievements();
                renderCustomPoolList();
                updateCoinDisplay();
                updateMascotAppearance();
                handleImport();

            }

            storageReady.then(loadAllData);
            let currentLevelIndex = 0, lives = 3, currentQuestions = [], currentQuestionIndex = 0, correctAnswersInLevel = 0, userAnswer = '', isChecking = false, activeScreen = 'start', levelResults = [], isMuted = false;
            let audioContext, bgmInterval, countdownInterval, timeRemaining;
            let confirmCallback = null;

            // --- ÂêâÁ••Áâ©ÊéßÂà∂ÈÇèËºØ (v3.2.0) ---
            const mascot = {
                container: document.getElementById('mascot-container'),
                bubble: document.getElementById('mascot-bubble'),
                say: function (text, duration = 3000) {
                    this.bubble.textContent = text;
                    this.bubble.classList.add('show');
                    if (this._timer) clearTimeout(this._timer);
                    this._timer = setTimeout(() => this.bubble.classList.remove('show'), duration);
                },
                jump: function () {
                    this.container.classList.remove('mascot-idle');
                    this.container.classList.add('mascot-bounce');
                    setTimeout(() => {
                        this.container.classList.remove('mascot-bounce');
                        this.container.classList.add('mascot-idle');
                    }, 500);
                },
                react: function (type) {
                    if (type === 'correct') {
                        const greets = ['‰Ω†ÁúüÊ£íÔºÅ', 'Â§™Âé≤ÂÆ≥‰∫ÜÔºÅ', 'Â•ΩËÅ∞ÊòéÂñîÔºÅ', 'Ê≠£Á¢∫ÔºÅ'];
                        this.say(greets[Math.floor(Math.random() * greets.length)]);
                        this.jump();
                    } else if (type === 'wrong') {
                        this.say('Ê≤íÈóú‰øÇÔºåÂÜçË©¶‰∏ÄÊ¨°ÔºÅ', 2000);
                    } else if (type === 'hint') {
                        this.say('ÊèêÁ§∫Âú®ÈÄôË£°ÂñîÔºÅ');
                    }
                }
            };
            window.mascot = mascot;

            function showConfirm(title, text, callback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-text').textContent = text;
                document.getElementById('confirm-modal-overlay').style.display = 'flex';
                confirmCallback = callback;
            }

            document.getElementById('confirm-ok').onclick = () => {
                document.getElementById('confirm-modal-overlay').style.display = 'none';
                if (confirmCallback) confirmCallback();
            };

            document.getElementById('confirm-cancel').onclick = () => {
                document.getElementById('confirm-modal-overlay').style.display = 'none';
                if (activeScreen === 'game') startTimer();
            };
            let currentCombo = 0, hintsLeft = 1;
            let currentScore = 0, isEndlessMode = false;
            let customPool = JSON.parse(localStorage.getItem('bopomofoCustomPool') || '[]');
            const QUESTIONS_PER_LEVEL = 5;
            const TIME_ADD_PER_QUESTION = 15; // Âõ∞Èõ£Ê®°Âºè‰∏ãÊØèÈ°åÂ¢ûÂä† 15 Áßí

            // --- ÂÆ∂Èï∑Ê®°ÂºèÊ†∏ÂøÉÈÇèËºØ ---
            async function saveCustomPool() {
                await window.storage.set('customPool', 'main', customPool);
                renderCustomPoolList();
            }

            function renderCustomPoolList() {
                const list = document.getElementById('custom-pool-list');
                list.innerHTML = customPool.length ? '' : '<p style="color:#666;">ÁõÆÂâçÈÇÑÊ≤íÊúâËá™Ë®ÇÈ°åÁõÆÂñîÔºÅ</p>';
                customPool.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'custom-item-row';
                    div.innerHTML = `
                        <div class="custom-item-info">
                            <span style="font-size:24px; font-weight:bold;">${item.char}</span>
                            <span style="color:var(--primary-color);">${item.bopomofo}</span>
                        </div>
                        <button class="delete-btn" onclick="removeCustomItem(${index})">Âà™Èô§</button>
                    `;
                    list.appendChild(div);
                });
            }

            window.removeCustomItem = (index) => {
                showConfirm('‚ùì Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü', 'Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÈÅìÈ°åÁõÆÂóéÔºüÊ≠§Âãï‰Ωú‰∏çÂèØÈÇÑÂéü„ÄÇ', () => {
                    customPool.splice(index, 1);
                    saveCustomPool();
                    updateLevelSelectScreen(); // Êõ¥Êñ∞Âú∞Ê®ôÊåâÈàï
                });
            };

            function handleImport() {
                const urlParams = new URLSearchParams(window.location.search);
                const importData = urlParams.get('import');
                if (importData) {
                    try {
                        const decoded = JSON.parse(atob(importData));
                        if (Array.isArray(decoded)) {
                            showConfirm('üì¶ ÂÅµÊ∏¨Âà∞ÂàÜ‰∫´È°åÂ∫´', `ÊòØÂê¶Ë¶ÅÂåØÂÖ•‰æÜËá™ËÄÅÂ∏´/ÂÆ∂Èï∑ÁöÑ ${decoded.length} ÂÄãÈ°åÁõÆÔºü`, () => {
                                // Âêà‰Ωµ‰∏¶ÂéªÈáç (‰ª•ÂúãÂ≠óÁÇ∫Ê∫ñ)
                                const existingChars = new Set(customPool.map(i => i.char));
                                const newItems = decoded.filter(i => !existingChars.has(i.char));
                                customPool = [...customPool, ...newItems];
                                saveCustomPool();
                                alert('ÂåØÂÖ•ÊàêÂäüÔºÅÊÇ®ÂèØ‰ª•Âú®„ÄåËá™Ë®ÇÂ∞àÂçÄ„ÄçÈñãÂßãÈÅäÁé©„ÄÇ');
                                // Ê∏ÖÈô§ URL ÂèÉÊï∏ÈÅøÂÖçÈáçË§áÂΩàÁ™ó
                                window.history.replaceState({}, document.title, window.location.pathname);
                                updateLevelSelectScreen();
                            });
                        }
                    } catch (e) {
                        console.error('ÂåØÂÖ•Â§±Êïó:', e);
                    }
                }
            }

            handleImport(); // ÂàùÂßãÂåñÊ™¢Êü•ÂåØÂÖ•

            // --- v3.0 Firebase Èõ≤Á´ØËàáÂ§ö‰∫∫ÈÄ£Á∑öÈÇèËºØ ---
            let currentRoomId = null;
            let isHost = false;
            let unsubRoom = null;

            async function uploadCustomPoolToCloud() {
                if (customPool.length === 0) return alert("È°åÂ∫´ÊòØÁ©∫ÁöÑÂñîÔºÅ");
                const poolName = prompt("Ë´ãÁÇ∫ÈÄôÂÄãÈ°åÂ∫´ÂèñÂÄãÂ•ΩËÅΩÁöÑÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂãïÊ§çÁâ©ÈÄ≤ÈöéÔºâÔºö") || "Êú™ÂëΩÂêçÈ°åÂ∫´";
                const shareCode = Math.floor(100000 + Math.random() * 900000).toString();

                try {
                    const btn = document.getElementById('upload-cloud-btn'); btn.textContent = "‰∏äÊû∂‰∏≠.."; btn.disabled = true;
                    await window.fbDB.collection("market").doc(shareCode).set({
                        name: poolName,
                        questions: customPool,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showConfirm("üéâ ‰∏äÊû∂ÊàêÂäüÔºÅ", `ÂàÜ‰∫´‰ª£Á¢ºÁÇ∫Ôºö„Äê${shareCode}„Äë\nÊÇ®ÁöÑË¶™ÂèãÁèæÂú®ÂèØ‰ª•Âú®Â∏ÇÈõÜËº∏ÂÖ•ÈÄô 6 ‰ΩçÊï∏Áõ¥Êé•Áç≤Âèñ„ÄÇ`, null);
                } catch (e) { alert("‰∏äÊû∂Â§±Êïó..."); }
                finally { const btn = document.getElementById('upload-cloud-btn'); btn.textContent = "‚òÅÔ∏è ‰∏äÊû∂Èõ≤Á´Ø"; btn.disabled = false; }
            }

            async function fetchCloudMarket() {
                const list = document.getElementById('market-list');
                list.innerHTML = "<p style='text-align: center; color: #64748b;'>Ê≠£Âú®ÈÄ£Á∑öËá≥Èõ≤Á´Ø...</p>";
                document.getElementById('cloud-market-overlay').style.display = 'flex';
                try {
                    const snap = await window.fbDB.collection("market").orderBy("createdAt", "desc").limit(10).get();
                    list.innerHTML = snap.empty ? "<p style='text-align: center; color: #64748b;'>ÁõÆÂâçÁ©∫Á©∫Â¶Ç‰πü</p>" : "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        const card = document.createElement('div');
                        card.className = "lobby-player-item";
                        card.style.cursor = "default";
                        card.innerHTML = `
                            <div>
                                <strong style="display:block; font-size:18px;">${d.name}</strong>
                                <small style="color:#64748b;">üìö ${d.questions.length} È°å</small>
                            </div>
                            <button class="btn" onclick="importCloudPool('${doc.id}')" 
                                style="font-size:16px; padding:8px 15px; margin:0; background:var(--primary-color);">üíæ ‰∏ãËºâ</button>
                        `;
                        list.appendChild(card);
                    });
                } catch (e) { list.innerHTML = "ÈÄ£Á∑öÂ§±Êïó"; }
            }

            window.importCloudPool = async (id) => {
                try {
                    const doc = await window.fbDB.collection("market").doc(id).get();
                    if (doc.exists) {
                        const qs = doc.data().questions;
                        const existing = new Set(customPool.map(i => i.char));
                        customPool = [...customPool, ...qs.filter(q => !existing.has(q.char))];
                        saveCustomPool(); alert("‚úÖ ‰∏ãËºâÂåØÂÖ•ÂÆåÊàêÔºÅ");
                        document.getElementById('cloud-market-overlay').style.display = 'none';
                    }
                } catch (e) { alert("‰∏ãËºâÂ§±Êïó"); }
            };

            async function createMultiplayerRoom() {
                const id = Math.floor(100000 + Math.random() * 900000).toString();
                const name = prompt("Êàø‰∏ªÂêçÁ®±Ôºö") || "ËÄÅÂ∏´";
                if (!window.fbAuth.currentUser) return alert("‚ùå ÊÇ®Â∞öÊú™ÁôªÂÖ•Èõ≤Á´ØÔºàÂèØËÉΩÊòØÁ∂≤Ë∑ØÊàñÈ©óË≠âÊúçÂãôÊú™ÂïüÂãïÔºâÔºåÁÑ°Ê≥ïÂª∫Á´ãÊàøÈñì„ÄÇ");
                await window.fbDB.collection("rooms").doc(id).set({
                    status: "waiting",
                    players: [{ name: name, score: 0, id: window.fbAuth.currentUser.uid }]
                });
                currentRoomId = id; isHost = true; showLobby(id);
            }

            async function joinMultiplayerRoom() {
                const id = document.getElementById('room-id-input').value.trim();
                const name = prompt("ÊÇ®ÁöÑÂêçÂ≠óÔºö") || "Áé©ÂÆ∂";
                const ref = window.fbDB.collection("rooms").doc(id);
                const doc = await ref.get();
                if (!doc.exists) return alert("Êü•ÁÑ°Ê≠§ÊàøÈñì");
                if (!window.fbAuth.currentUser) return alert("‚ùå ÊÇ®Â∞öÊú™ÁôªÂÖ•Èõ≤Á´ØÔºåÁÑ°Ê≥ïÂä†ÂÖ•ÊàøÈñì„ÄÇ");
                await ref.update({ players: firebase.firestore.FieldValue.arrayUnion({ name: name, score: 0, id: window.fbAuth.currentUser.uid }) });
                currentRoomId = id; isHost = false; showLobby(id);
            }

            function showLobby(id) {
                document.getElementById('multiplayer-setup').style.display = 'none';
                document.getElementById('lobby-view').style.display = 'block';
                document.getElementById('display-room-id').textContent = id;
                if (isHost) document.getElementById('start-multiplayer-game-btn').style.display = 'block';
                if (unsubRoom) unsubRoom();
                unsubRoom = window.fbDB.collection("rooms").doc(id).onSnapshot(doc => {
                    if (!doc.exists) return;
                    const d = doc.data();
                    document.getElementById('player-list').innerHTML = d.players.map(p => `
                        <div class="lobby-player-item">
                            <span>üë§ ${p.name}</span>
                            <span style="color:var(--accent-color)">${p.score} ÂàÜ</span>
                        </div>
                    `).join('');
                    if (d.status === "playing" && activeScreen !== 'game') {
                        currentQuestions = gameLevels.flatMap(l => l.questions).sort(() => 0.5 - Math.random()).slice(0, 5);
                        isEndlessMode = false; currentLevelIndex = 999;
                        lives = 3; currentQuestionIndex = 0; currentScore = 0;
                        showScreen('game'); loadQuestion();
                        document.getElementById('multiplayer-overlay').style.display = 'none';
                    }
                });
            }

            async function triggerStartGame() {
                if (isHost) await window.fbDB.collection("rooms").doc(currentRoomId).update({ status: "playing" });
            }

            async function syncScoreToCloud() {
                const ref = window.fbDB.collection("rooms").doc(currentRoomId);
                const doc = await ref.get();
                const p = doc.data().players.map(player => player.id === window.fbAuth.currentUser.uid ? { ...player, score: currentScore } : player);
                await ref.update({ players: p });
            }

            function speakWord(word) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel(); // Ê∏ÖÈô§ÊéíÈöä‰∏≠ÁöÑË™ûÈü≥
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'zh-TW';
                    utterance.rate = 0.9;  // Á®çÂæÆÂä†Âø´ÈÄüÁéá
                    utterance.pitch = 1.1; // ÊèêÈ´òÈü≥Ë™øÂ¢ûÂä†Á©øÈÄèÂäõ
                    utterance.volume = 1.0; // ÈéñÂÆöÊúÄÂ§ßÈü≥Èáè

                    // Ducking: Ë™™Ë©±ÊôÇËá™ÂãïÂ£ì‰ΩéËÉåÊôØÈü≥Ê®ÇÈü≥Èáè
                    if (window.bgmAudio && !isMuted) {
                        window.bgmAudio.volume = 0.2;
                        utterance.onend = () => {
                            if (window.bgmAudio && !isMuted) window.bgmAudio.volume = 0.6;
                        };
                    }

                    window.speechSynthesis.speak(utterance);
                }
            }

            function updateDynamicBackground(levelIndex) {
                const gameScreen = document.getElementById('game-screen');
                gameScreen.className = 'screen active'; // reset
                const themeName = gameLevels[levelIndex].name;
                if (themeName === 'Â§©Ê∞£') gameScreen.classList.add('theme-rain');
                else if (themeName === 'È°èËâ≤') gameScreen.classList.add('theme-star');
                else if (themeName === 'È£üÁâ©') gameScreen.classList.add('theme-food');
                else if (themeName === 'Ê∞¥Êûú') gameScreen.classList.add('theme-fruit');
                else if (themeName === 'Ëá™ÁÑ∂') gameScreen.classList.add('theme-nature');
                else if (themeName === 'ÊòÜËü≤') gameScreen.classList.add('theme-insect');
                else if (themeName === 'Âãï‰Ωú') gameScreen.classList.add('theme-action');
                else if (themeName === 'Êó•Â∏∏') gameScreen.classList.add('theme-daily');
                else gameScreen.classList.add('theme-warm');
            }

            function renderAchievements() {
                achievementsContainer.innerHTML = '';

                // 1. ÈóúÂç°ÊàêÂ∞± (Level Achievements)
                gameLevels.forEach(level => {
                    const isUnlocked = gameState.achievements && gameState.achievements.includes(level.name);
                    const badge = document.createElement('div');
                    badge.className = `achievement-badge ${isUnlocked ? 'unlocked' : ''}`;
                    badge.innerHTML = `<div class="icon">${level.icon}</div><div class="name">${level.name}ÈÄöÈóú</div>`;
                    achievementsContainer.appendChild(badge);
                });

                // 2. ÁâπÊÆäÊàêÂ∞± 2.0 (Special Achievements)
                const specialAchievements = [
                    { id: 'streak3', name: 'ÈÄ£Áôª3Â§©', icon: 'üî•', condition: () => (bopomofoStats.loginStreak || 0) >= 3 },
                    { id: 'streak10', name: 'ÈÄ£Áôª10Â§©', icon: 'üìÖ', condition: () => (bopomofoStats.loginStreak || 0) >= 10 },
                    { id: 'correct100', name: 'Á≠îÂ∞ç100È°å', icon: 'üíØ', condition: () => (bopomofoStats.totalCorrect || 0) >= 100 },
                    { id: 'correct500', name: 'Áü•Ë≠òÈÅî‰∫∫', icon: 'üèÜ', condition: () => (bopomofoStats.totalCorrect || 0) >= 500 }
                ];

                specialAchievements.forEach(sa => {
                    const isUnlocked = sa.condition();
                    const badge = document.createElement('div');
                    badge.className = `achievement-badge ${isUnlocked ? 'unlocked' : ''}`;
                    badge.innerHTML = `<div class="icon">${sa.icon}</div><div class="name">${sa.name}</div>`;
                    achievementsContainer.appendChild(badge);
                });
            }

            async function saveGameState() {
                await window.storage.set('settings', 'gameState', gameState);
            }
            function loadGameState() { } // Â∑≤Áî± loadAllData Âèñ‰ª£
            function initAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                // Ëß£Èô§ iOS/Safari ÂèäÂêÑÈ°ûË°åÂãïË£ùÁΩÆÁöÑ TTS Ë™ûÈü≥ÈôêÂà∂
                if ('speechSynthesis' in window) {
                    const silentUtterance = new SpeechSynthesisUtterance('');
                    silentUtterance.volume = 0;
                    window.speechSynthesis.speak(silentUtterance);
                }
            }
            function playNote(frequency, type = 'sine', duration = 0.1) { if (isMuted || !audioContext) return; try { const o = audioContext.createOscillator(), g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); o.type = type; o.frequency.setValueAtTime(frequency, audioContext.currentTime); g.gain.setValueAtTime(0.2, audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + duration); o.start(); o.stop(audioContext.currentTime + duration); } catch (e) { } }
            function playSound(type) {
                // ÂÑ™ÂÖà‰ΩøÁî®ÂØ¶È´îÈü≥Ê™î
                const audio = new Audio(`./assets/sounds/${type}.mp3`);
                audio.play().catch(() => {
                    // Fallback Âà∞ÂêàÊàêÈü≥
                    if (type === 'correct') playNote(600, 'sine', 0.5);
                    else if (type === 'wrong') playNote(150, 'square', 0.2);
                    else if (type === 'touch') playNote(440, 'triangle', 0.1);
                });
            }
            function toggleBgm() {
                if (isMuted) {
                    if (window.bgmAudio) window.bgmAudio.pause();
                    return;
                }
                if (!window.bgmAudio) {
                    window.bgmAudio = new Audio('./assets/sounds/bgm.mp3');
                    window.bgmAudio.loop = true;
                    window.bgmAudio.volume = 0.6; // Ë®≠ÂÆöÈ†êË®≠Èü≥ÈáèÔºåÁïôÂá∫Ë™ûÈü≥Á©∫Èñì
                }
                window.bgmAudio.play().catch(() => {
                    // Fallback Âà∞ÂéüÊúâÂêàÊàê BGM ÈÇèËºØ
                    if (!audioContext) return;
                    if (bgmInterval) return;
                    const notes = [261, 293, 329, 349]; let noteIndex = 0;
                    bgmInterval = setInterval(() => { playNote(notes[noteIndex % notes.length], 'sine', 0.3); noteIndex++; }, 500);
                });
            }

            function updateCoinDisplay() {
                const count = gameState.coins || 0;
                const shopDisplay = document.getElementById('shop-coin-count');
                const gameDisplay = document.getElementById('game-coin-count');
                if (shopDisplay) shopDisplay.textContent = count;
                if (gameDisplay) gameDisplay.textContent = count;
            }

            function renderShop() {
                updateCoinDisplay();
                const grid = document.getElementById('shop-grid');
                grid.innerHTML = '';
                const ownedHats = gameState.inventory?.hats || [];
                const equippedHat = gameState.equipped?.hat || null;

                shopItems.forEach(item => {
                    const isOwned = ownedHats.includes(item.id);
                    const isEquipped = equippedHat === item.id;
                    const btnHtml = isEquipped
                        ? `<button class="btn" disabled style="background:#9ca3af; margin:0; padding:10px; width:100%; font-size:16px;">‚úÖ Â∑≤Ë£ùÂÇô</button>`
                        : isOwned
                            ? `<button class="btn" onclick="equipItem('${item.id}', '${item.type}')" style="background:#3b82f6; margin:0; padding:10px; width:100%; font-size:16px;">Ë£ùÂÇô</button>`
                            : `<button class="btn" onclick="buyItem('${item.id}')" style="background:#10b981; margin:0; padding:10px; width:100%; font-size:16px;">üí∞ ${item.price}</button>`;

                    grid.innerHTML += `
                        <div style="background: white; border-radius: 20px; padding: 20px; text-align: center; box-shadow: var(--clay-shadow-btn); display: flex; flex-direction: column; justify-content: space-between; align-items:center;">
                            <div style="font-size: 60px; margin-bottom: 10px; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));">${item.emoji}</div>
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #475569;">${item.name}</div>
                            ${btnHtml}
                        </div>
                    `;
                });
            }

            window.buyItem = (itemId) => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;
                if ((gameState.coins || 0) >= item.price) {
                    playSound('correct');
                    gameState.coins -= item.price;
                    if (!gameState.inventory) gameState.inventory = { hats: [], colors: [] };
                    if (!gameState.inventory.hats) gameState.inventory.hats = [];
                    gameState.inventory.hats.push(itemId);
                    saveGameState();
                    renderShop();
                    mascot.say(`ÊàêÂäüË≥ºË≤∑ ${item.name}ÔºÅÂø´ÂéªË£ùÂÇôÁúãÁúãÂêßÔºÅ`, 4000);
                } else {
                    playSound('wrong');
                    mascot.say(`ÈáëÂπ£‰∏çÂ§†ÂñîÔºÅÂø´ÂéªÁ†¥ÈóúË≥∫ÈáëÂπ£ÂêßÔºÅ`, 4000);
                }
            };

            window.equipItem = (itemId, type) => {
                playSound('touch');
                if (!gameState.equipped) gameState.equipped = {};
                if (gameState.equipped[type] === itemId) {
                    gameState.equipped[type] = null; // Âç∏‰∏ã
                } else {
                    gameState.equipped[type] = itemId; // Ë£ùÂÇô
                }
                saveGameState();
                renderShop();
                mascot.say(`ÊèõË£ùÂÆåÊàêÔºÅÊàëÁèæÂú®ÁúãËµ∑‰æÜÂæàÈÖ∑Â∞çÂêßÔºÅ`, 3000);
                updateMascotAppearance();
            };

            window.updateMascotAppearance = () => {
                const existingHats = mascot.container.querySelectorAll('.equipped-hat');
                existingHats.forEach(h => h.remove());

                if (gameState.equipped?.hat) {
                    const hatItem = shopItems.find(i => i.id === gameState.equipped.hat);
                    if (hatItem) {
                        const hatEl = document.createElement('div');
                        hatEl.className = 'equipped-hat';
                        hatEl.textContent = hatItem.emoji;
                        hatEl.style.position = 'absolute';
                        hatEl.style.top = '-35px';
                        hatEl.style.left = '45%'; // Á®çÂæÆÂêëÂ∑¶ÂÅè‰∏ÄÈªûÈÖçÂêàÂ§ñÊòü‰∫∫ËßíÂ∫¶
                        hatEl.style.transform = 'translateX(-50%) rotate(-10deg)';
                        hatEl.style.fontSize = '85px';
                        hatEl.style.zIndex = '5';
                        hatEl.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        hatEl.style.filter = 'drop-shadow(0 5px 5px rgba(0,0,0,0.3))';

                        mascot.container.appendChild(hatEl);
                    }
                }
            };

            function showScreen(screenId) {
                activeScreen = screenId;
                document.querySelectorAll('.screen.active').forEach(s => {
                    s.classList.remove('active');
                });

                // ÂãïÊÖãÂèñÂæóÁõÆÊ®ôËû¢ÂπïÂÖÉ‰ª∂ (Â¶ÇÊûúÊ≤íÊúâÂ≠òÂú® cache ‰∏≠)
                const targetScreen = screens[screenId] || document.getElementById(`${screenId}-screen`);
                if (targetScreen) targetScreen.classList.add('active');
            }
            function triggerConfetti() {
                const shapes = ['confetti-round', 'confetti-star', 'confetti-heart', 'confetti-square'];
                const colors = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#FF922B', '#CC5DE8', '#F06595', '#20C997'];
                const count = 60;
                for (let i = 0; i < count; i++) {
                    const c = document.createElement('div');
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const size = 8 + Math.random() * 12;
                    c.className = `confetti ${shape}`;
                    c.style.left = `${Math.random() * 100}vw`;
                    c.style.top = `${-30 - Math.random() * 30}px`;
                    c.style.width = `${size}px`;
                    c.style.height = `${size}px`;
                    c.style.backgroundColor = color;
                    c.style.animationDuration = `${1.2 + Math.random() * 1.2}s`;
                    c.style.animationDelay = `${Math.random() * 0.6}s`;
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 3000);
                }
            }

            function checkAnswer(timeoutObj = false) {
                if (isChecking) return; isChecking = true;
                clearInterval(countdownInterval);
                const correctAnswer = currentQuestions[currentQuestionIndex].bopomofo;
                const isCorrect = !timeoutObj && userAnswer === correctAnswer;
                levelResults.push({ question: currentQuestions[currentQuestionIndex], isCorrect: isCorrect });
                if (isCorrect) {
                    playSound('correct'); correctAnswersInLevel++;

                    // Combo Logic 2.0
                    currentCombo++;
                    currentScore += (100 * (isEndlessMode ? 1.5 : 1)) + (currentCombo * 20); // ÂàÜÊï∏Ë®àÁÆóÂä†‰∏äÈÄ£ÊìäÂä†Êàê

                    if (currentCombo >= 2) {
                        comboDisplay.textContent = `${currentCombo} ÈÄ£Êìä! ${currentCombo >= 5 ? 'üî•' : ''}`;
                        comboDisplay.classList.remove('active', 'fire');
                        void comboDisplay.offsetWidth; // trigger reflow
                        comboDisplay.classList.add('active');
                        if (currentCombo >= 5) comboDisplay.classList.add('fire');
                    } else {
                        comboDisplay.classList.remove('active', 'fire');
                    }

                    feedbackMessage.textContent = 'Á≠îÂ∞ç‰∫ÜÔºÅÂ§™Ê£í‰∫ÜÔºÅ'; feedbackMessage.className = 'feedback-correct';
                    interactionArea.classList.add('correct'); triggerConfetti();
                    mascot.react('correct');
                    if (navigator.vibrate) navigator.vibrate(50); // ÈúáÂãïÂõûÈ•ã
                    progressBarInner.style.width = `${(correctAnswersInLevel / currentQuestions.length) * 100}%`;

                    // --- v3.0 Â§ö‰∫∫Âç≥ÊôÇÂêåÊ≠• ---
                    if (currentLevelIndex === 999) syncScoreToCloud();

                    // Âä†ÂÄçÁçéÂãµÊôÇÈñì
                    if (currentLevelIndex >= 3) {
                        timeRemaining += TIME_ADD_PER_QUESTION;
                    }

                    setTimeout(() => { interactionArea.classList.remove('correct'); currentQuestionIndex++; loadQuestion(); }, 2000);
                    updateStats(currentQuestions[currentQuestionIndex].bopomofo, true);
                } else {
                    currentCombo = 0; comboDisplay.classList.remove('active'); // Reset Combo
                    mascot.react('wrong');
                    playSound('wrong'); lives--; updateLivesDisplay();
                    updateStats(currentQuestions[currentQuestionIndex].bopomofo, false);
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]); // ÈúáÂãïÂõûÈ•ã

                    // Â±ïÁ§∫Ê≠£Á¢∫Á≠îÊ°àÂ∞èÂç°
                    const label = timeoutObj ? `‚è∞ ${correctAnswer}` : `Ê≠£Á¢∫Ôºö${correctAnswer}`;
                    answerHintCard.textContent = label;
                    answerHintCard.classList.remove('hide');
                    void answerHintCard.offsetWidth;
                    answerHintCard.classList.add('show');
                    setTimeout(() => {
                        answerHintCard.classList.remove('show');
                        answerHintCard.classList.add('hide');
                    }, 1800);

                    feedbackMessage.textContent = timeoutObj ? `ÊôÇÈñìÂà∞ÔºÅÁ≠îÊ°àÊòØ ${correctAnswer}` : `Â∑Æ‰∏ÄÈªûÈªûÔºÅÊòØ ${correctAnswer}`; feedbackMessage.className = 'feedback-wrong';
                    interactionArea.classList.add('wrong');
                    setTimeout(() => {
                        interactionArea.classList.remove('wrong');
                        if (lives <= 0) { endLevel(false); } else { currentQuestionIndex++; loadQuestion(); }
                    }, 2500);
                }
            }

            function updateLevelSelectScreen() {
                levelSelectContainer.innerHTML = '';
                gameLevels.forEach((level, index) => {
                    const isLocked = (index + 1) > gameState.unlockedLevels;
                    const btn = document.createElement('button'); btn.className = `btn level-btn ${isLocked ? 'locked' : ''}`; btn.disabled = isLocked;
                    const hearts = gameState.hearts[index + 1] || 0;
                    btn.innerHTML = `<div class="level-icon">${level.icon}</div><div>${level.name}</div><div class="hearts">${'‚ù§Ô∏è'.repeat(hearts)}${'ü§ç'.repeat(3 - hearts)}</div>`;
                    if (!isLocked) { btn.onclick = () => { playSound('touch'); startGame(index); }; }
                    levelSelectContainer.appendChild(btn);
                });

                // Êñ∞Â¢ûËá™Ë®ÇÂ∞àÂçÄÊåâÈàï (Â¶ÇÊûúÈ°åÂ∫´‰∏çÁÇ∫Á©∫)
                if (customPool.length > 0) {
                    const customBtn = document.createElement('button');
                    customBtn.className = 'btn level-btn custom-zone';
                    customBtn.style.backgroundColor = '#6BCB77';
                    customBtn.innerHTML = `<div class="level-icon">üåü</div><div>Ëá™Ë®ÇÂ∞àÂçÄ</div><div class="hearts">${customPool.length} È°å</div>`;
                    customBtn.onclick = () => { playSound('touch'); startGame(-1); }; // -1 ‰ª£Ë°®Ëá™Ë®ÇÊ®°Âºè
                    levelSelectContainer.appendChild(customBtn);
                }

                // --- „ÄêË£úÊïëÊïôÂ≠∏„ÄëÁµÇÊ•µÊåëÊà∞ ---
                const weakSpots = Object.entries(bopomofoStats)
                    .filter(([k, v]) => v.total >= 3 && (v.correct / v.total) < 0.7)
                    .sort((a, b) => (a[1].correct / a[1].total) - (b[1].correct / b[1].total))
                    .slice(0, 5)
                    .map(entry => entry[0]);

                if (weakSpots.length >= 2) {
                    const challengeBtn = document.createElement('button');
                    challengeBtn.className = 'btn level-btn challenge-zone';
                    challengeBtn.style.background = 'linear-gradient(135deg, #EF4444, #F97316)';
                    challengeBtn.innerHTML = `<div class="level-icon">üî•</div><div>ÁµÇÊ•µÊåëÊà∞</div><div class="hearts">${weakSpots.length} ÂÄãÈáçÈõ£Èªû</div>`;
                    challengeBtn.onclick = () => {
                        playSound('touch');
                        const allQs = gameLevels.flatMap(l => l.questions);
                        const challengeQs = weakSpots.map(symbol => {
                            return allQs.find(q => q.bopomofo.includes(symbol)) || allQs[0];
                        }).slice(0, 5);
                        currentQuestions = challengeQs;
                        currentLevelIndex = 888;
                        isEndlessMode = false; lives = 3; currentQuestionIndex = 0; correctAnswersInLevel = 0;
                        levelResults = []; updateLivesDisplay(); progressBarInner.style.width = '0%';
                        document.getElementById('game-screen').className = 'screen active theme-rainbow';
                        showScreen('game'); loadQuestion();
                        mascot.say("ÊàëÂÄë‰æÜÊîªÂÖãÈÄô‰∫õÈõ£È°åÂêßÔºÅ");
                    };
                    levelSelectContainer.appendChild(challengeBtn);
                }
            }

            function populateReviewScreen() {
                reviewContainer.innerHTML = '';
                levelResults.forEach(result => {
                    const item = document.createElement('div'); item.className = `review-item ${result.isCorrect ? 'correct' : 'wrong'}`;
                    item.innerHTML = `<div class="review-text">${result.question.char}<span>${result.question.bopomofo}</span></div><div class="review-icon">${result.isCorrect ? '‚úÖ' : '‚ùå'}</div>`;
                    reviewContainer.appendChild(item);
                });
                const nextBtn = screens.levelReview.querySelector('#next-level-btn');
                const wasSuccess = lives > 0;
                nextBtn.style.display = (wasSuccess && currentLevelIndex + 1 < gameLevels.length) ? 'inline-block' : 'none';
            }

            function endLevel(isSuccess) {
                clearInterval(countdownInterval);
                const endScreen = screens.levelEnd, title = endScreen.querySelector('h2'), heartsDisplay = endScreen.querySelectorAll('.heart'), msg = endScreen.querySelector('p');
                const heartsEarned = isSuccess ? lives : 0;

                // ÂàÜÊï∏ËàáÊéíË°åÊ¶úÈÇèËºØ
                const scoreDisplay = endScreen.querySelector('#score-display');
                const leaderboardPanel = endScreen.querySelector('#leaderboard-panel');
                const leaderboardList = endScreen.querySelector('#leaderboard-list');

                if (isEndlessMode || isSuccess) {
                    // ÈáëÂπ£ÁôºÊîæÔºö100 ÂàÜ = 1 ÊûöÈáëÂπ£
                    const coinsEarned = Math.floor(currentScore / 100);
                    gameState.coins = (gameState.coins || 0) + coinsEarned;

                    scoreDisplay.style.display = 'block';
                    scoreDisplay.textContent = `ÂæóÂàÜÔºö${currentScore} (Áç≤Âæó üí∞ ${coinsEarned} ÈáëÂπ£)`;

                    // Á¥ÄÈåÑÊéíË°åÊ¶ú
                    let highScores = JSON.parse(localStorage.getItem('bopomofoHighScores') || '[]');
                    highScores.push({ score: currentScore, date: new Date().toLocaleDateString() });
                    highScores.sort((a, b) => b.score - a.score);
                    highScores = highScores.slice(0, 5);
                    localStorage.setItem('bopomofoHighScores', JSON.stringify(highScores));

                    // È°ØÁ§∫ÊéíË°åÊ¶ú
                    leaderboardPanel.style.display = 'block';
                    leaderboardList.innerHTML = highScores.map((s, i) =>
                        `<div class="leaderboard-item">
                            <span class="rank">${i + 1}</span>
                            <span>${s.date}</span>
                            <span class="score">${s.score}</span>
                        </div>`
                    ).join('');
                } else {
                    scoreDisplay.style.display = 'none';
                    leaderboardPanel.style.display = 'none';
                }

                if (isSuccess) {
                    title.textContent = isEndlessMode ? "ÊåëÊà∞ÁµêÊùü" : "ÊåëÊà∞ÊàêÂäüÔºÅ";
                    if (!isEndlessMode) {
                        const oldHearts = gameState.hearts[currentLevelIndex + 1] || 0; gameState.hearts[currentLevelIndex + 1] = Math.max(oldHearts, heartsEarned);
                        msg.textContent = heartsEarned === 3 ? "ÂÆåÁæéÈÄöÈóúÔºÅÂ§™Âé≤ÂÆ≥‰∫ÜÔºÅ" : "‰Ω†ÁúüÊ£íÔºÅ";
                        if (heartsEarned > 0 && (currentLevelIndex + 2 > gameState.unlockedLevels) && (currentLevelIndex + 1 < gameLevels.length)) { gameState.unlockedLevels = currentLevelIndex + 2; }
                    } else {
                        msg.textContent = `ÁÑ°Áõ°ÊåëÊà∞ÁµêÊùüÔºÅ‰Ω†‰∏ÄÂÖ±Á≠îÂ∞ç‰∫Ü ${correctAnswersInLevel} È°åÔºÅ`;
                    }

                    // Achievement Unlock Logic
                    if (heartsEarned === 3) {
                        if (!gameState.achievements) gameState.achievements = [];
                        const themeName = gameLevels[currentLevelIndex].name;
                        if (!gameState.achievements.includes(themeName)) {
                            gameState.achievements.push(themeName);
                        }
                    }
                } else {
                    title.textContent = "ÊåëÊà∞Â§±Êïó"; msg.textContent = "Âà•ÁÅ∞ÂøÉÔºåÁúãÁúãÂì™Ë£°Á≠îÈåØ‰∫ÜÔºÅ";
                }
                heartsDisplay.forEach((heart, i) => { heart.classList.remove('active'); heart.textContent = 'ü§ç'; if (i < heartsEarned) { setTimeout(() => { heart.classList.add('active'); heart.textContent = '‚ù§Ô∏è'; }, i * 300); } });
                saveGameState(); updateLevelSelectScreen(); showScreen('levelEnd');

                // ÈÄöÈóúÊàêÂäüÊôÇÊí≠ÊîæÂÆ∂Èï∑ÈºìÂãµË™ûÈü≥
                if (isSuccess) {
                    window.storage.get('media', 'parentEncouagement').then(blob => {
                        if (blob) {
                            setTimeout(() => {
                                const url = URL.createObjectURL(blob);
                                const audio = new Audio(url);
                                audio.play();
                                mascot.say("Áà∏Áà∏Â™ΩÂ™ΩÊúâË©±Ë∑ü‰Ω†Ë™™ÂñîÔºÅ");
                            }, 1500);
                        }
                    });
                }
            }

            function startTimer() {
                clearInterval(countdownInterval);
                if (currentLevelIndex < 3) return; // Ââç‰∏âÈóú‰∏çË®àÊôÇ

                function updateTimeString() {
                    const chars = ['üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö', 'üïõ'];
                    timeLeftSpan.textContent = `${timeRemaining} Áßí`;
                    if (timeRemaining <= 10) { timerDisplay.classList.add('timer-warning'); } else { timerDisplay.classList.remove('timer-warning'); }
                }
                updateTimeString();

                countdownInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimeString();
                    if (timeRemaining <= 0) {
                        clearInterval(countdownInterval);
                        checkAnswer(true); // Timeout Answer
                    }
                }, 1000);
            }

            function loadQuestion() {
                if (isEndlessMode && currentQuestionIndex >= currentQuestions.length - 1) {
                    // Â¶ÇÊûúÊòØÁÑ°Áõ°Ê®°Âºè‰∏îÈ°åÁõÆÂø´‰∏çÂ§†‰∫ÜÔºåÂÜçË£ú‰∏ÄËº™Èö®Ê©üÈ°å
                    const allPool = [];
                    gameLevels.forEach(l => allPool.push(...l.questions));
                    currentQuestions.push(...[...allPool].sort(() => 0.5 - Math.random()));
                }

                if (currentQuestionIndex >= currentQuestions.length) { endLevel(true); return; }
                userAnswer = ''; isChecking = false; feedbackMessage.textContent = ''; updateAnswerDisplay();
                const q = currentQuestions[currentQuestionIndex];

                // ÈáçË®≠ÂúñÁâáËàá Fallback ÁãÄÊÖã
                if (q.emoji) {
                    // Ëã•Ê≠§È°å‰ΩøÁî® emoji Ê®°ÂºèÔºåÈö±ËóèÂúñÁâáÂÖÉÂª∫‰∏¶Áõ¥Êé•È°ØÁ§∫ emoji
                    questionImage.style.display = 'none';
                    questionImageFallback.style.display = 'flex';
                    questionImageFallback.textContent = q.emoji;
                } else {
                    questionImage.style.display = 'block';
                    questionImageFallback.style.display = 'none';
                    questionImage.src = q.image;
                    // Ëã•ÂúñÁâáËºâÂÖ•Â§±ÊïóÁöÑ‰øùÂ∫ïÔºöÂÑ™ÂÖà‰ΩøÁî®Ëá™Ë®Ç emojiÔºåÊ≤íÊúâÁöÑË©±‰ΩøÁî®ÈóúÂç°ÂúñÁ§∫
                    questionImageFallback.textContent = q.emoji || (currentLevelIndex === -1 ? 'üåü' : gameLevels[currentLevelIndex].icon);
                }

                charDisplay.textContent = q.char;
                speechBtn.onclick = () => speakWord(q.char);

                if (currentLevelIndex >= 3 || isEndlessMode) {
                    timerDisplay.style.display = 'block';
                    timeRemaining = 20 + Math.min(30, currentQuestionIndex); // ÁÑ°Áõ°Ê®°Âºè‰∏ãÂãïÊÖãÂ¢ûÂä†Èõ£Â∫¶
                    startTimer();
                } else {
                    timerDisplay.style.display = 'none';
                }
            }
            function startGame(levelIndex) {
                initAudio(); toggleBgm();
                currentLevelIndex = levelIndex;
                isEndlessMode = false;
                lives = 3; currentQuestionIndex = 0; correctAnswersInLevel = 0;
                currentCombo = 0; currentScore = 0;
                levelResults = [];

                // ÂèñÊ®£È°åÁõÆ
                if (levelIndex === -1) {
                    currentQuestions = [...customPool].sort(() => 0.5 - Math.random());
                } else {
                    const allQs = gameLevels[levelIndex].questions;
                    currentQuestions = [...allQs].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_LEVEL);
                }

                updateLivesDisplay(); progressBarInner.style.width = '0%';
                if (levelIndex === -1) {
                    document.getElementById('game-screen').className = 'screen active theme-warm';
                } else {
                    updateDynamicBackground(levelIndex);
                }
                showScreen('game'); loadQuestion();
            }

            function startEndlessMode() {
                initAudio(); toggleBgm();
                isEndlessMode = true;
                lives = 3; currentQuestionIndex = 0; correctAnswersInLevel = 0;
                currentCombo = 0; currentScore = 0;
                levelResults = [];

                // Êî∂ÈõÜÊâÄÊúâÈóúÂç°ÁöÑÈ°åÁõÆ
                const allQuestionsPool = [];
                gameLevels.forEach(l => allQuestionsPool.push(...l.questions));

                // Ë®≠‰∏ÄÂÄãÊ•µÂ§ßÂÄº‰ΩúÁÇ∫ÁÑ°Áõ°Ê®°ÂºèÁöÑ question Èô£ÂàóÔºåÂãïÊÖãËøΩÂä†
                currentQuestions = [...allQuestionsPool].sort(() => 0.5 - Math.random());

                updateLivesDisplay(); progressBarInner.style.width = '0%';
                // ‰ΩøÁî®Èö®Ê©üËÉåÊôØ
                updateDynamicBackground(Math.floor(Math.random() * gameLevels.length));
                showScreen('game'); loadQuestion();
            }
            function updateLivesDisplay() { livesDisplay.textContent = '‚ù§Ô∏è'.repeat(lives); }
            function parseBopomofo(str) { const p = { c: '', m: '', f: '', t: '' }; let r = str; for (const t of bopomofoParts.tones) { if (r.includes(t)) { p.t = t; r = r.replace(t, ''); break; } } if (r.length > 0 && bopomofoParts.consonants.includes(r[0])) { p.c = r[0]; r = r.substring(1); } if (r.length > 0 && bopomofoParts.medials.includes(r[0])) { p.m = r[0]; r = r.substring(1); } p.f = r; return p; }
            function updateAnswerDisplay() { const p = parseBopomofo(userAnswer); let blockHTML = ''; const cH = p.c ? `<div class="consonant">${p.c}</div>` : ''; const vH = (p.m || p.f) ? `<div class="vowel-cluster">${p.m ? `<div class="medial">${p.m}</div>` : ''}${p.f ? `<div class="final">${p.f}</div>` : ''}</div>` : ''; if (specialStackConsonants.includes(p.c)) { const all = [p.c, p.m, p.f].filter(Boolean).join('<br>'); blockHTML = `<div class="phonetic-block-vertical">${all}</div>`; } else if (topSideConsonants.includes(p.c)) { blockHTML = `<div class="phonetic-block-vertical">${cH}${vH}</div>`; } else { blockHTML = `<div class="phonetic-block-horizontal">${cH}${vH}</div>`; } let finalHTML; if (p.t === 'Àô') { finalHTML = `<div class="phonetic-wrapper"><div class="light-tone-dot">Àô</div>${blockHTML}</div>`; } else { const tH = p.t ? `<div class="tone-block">${p.t}</div>` : ''; finalHTML = `<div class="phonetic-block-wrapper">${blockHTML}${tH}</div>`; } bopomofoAnswer.innerHTML = finalHTML; }
            function getSymbolType(s) { if (bopomofoParts.consonants.includes(s)) return 'consonant'; if (bopomofoParts.tones.includes(s)) return 'tone'; if (bopomofoParts.medials.includes(s)) return 'medial'; if (bopomofoParts.finals.includes(s)) return 'final'; return null; }
            function createKeyboard() { const groups = { consonants: bopomofoParts.consonants, vowels: allVowelsForButtons, tones: bopomofoParts.tones }; for (const group in groups) { const container = document.getElementById(group); groups[group].forEach(symbol => { const btn = document.createElement('button'); btn.className = 'bopomofo-btn'; btn.textContent = symbol; btn.onclick = () => { playSound('touch'); speakWord(symbol); let p = parseBopomofo(userAnswer); const type = getSymbolType(symbol); if (type === 'consonant') p.c = symbol; else if (type === 'tone') p.t = symbol; else if (type === 'medial') p.m = symbol; else if (type === 'final') p.f = symbol; userAnswer = p.c + p.m + p.f + p.t; updateAnswerDisplay(); }; container.appendChild(btn); }); } }

            const allButtons = document.querySelectorAll('.btn');
            allButtons.forEach(btn => btn.addEventListener('click', () => playSound('touch')));
            document.getElementById('start-game-btn').addEventListener('click', () => { initAudio(); toggleBgm(); updateLevelSelectScreen(); showScreen('levelSelect'); });

            achievementsBtn.onclick = () => { playSound('touch'); renderAchievements(); showScreen('achievements'); };
            document.getElementById('shop-btn').onclick = () => { playSound('touch'); renderShop(); showScreen('shop'); };
            document.getElementById('close-shop-btn').onclick = () => { playSound('touch'); showScreen('start'); };
            backToStartBtn.onclick = () => { playSound('touch'); showScreen('start'); };
            document.getElementById('endless-mode-btn').onclick = () => { playSound('touch'); startEndlessMode(); };

            reviewBtn.addEventListener('click', () => { populateReviewScreen(); showScreen('levelReview'); });
            document.getElementById('back-to-map-btn').addEventListener('click', () => showScreen('levelSelect'));
            document.getElementById('retry-level-btn').addEventListener('click', () => startGame(currentLevelIndex));
            document.getElementById('next-level-btn').addEventListener('click', () => { if (currentLevelIndex + 1 < gameLevels.length) startGame(currentLevelIndex + 1); });

            hintBtn.addEventListener('click', () => {
                if (hintsLeft > 0) {
                    hintsLeft--;
                    hintBtn.textContent = 'üí° ÊèêÁ§∫Áî®Áõ°';
                    hintBtn.disabled = true;
                    // Provide hint: First character of the true bopomofo answer
                    const trueAns = parseBopomofo(currentQuestions[currentQuestionIndex].bopomofo);
                    let p = parseBopomofo(userAnswer);
                    p.c = trueAns.c; // Force the initial consonant or part
                    userAnswer = p.c + p.m + p.f + p.t;
                    updateAnswerDisplay();
                }
            });

            document.getElementById('view-market-btn')?.addEventListener('click', fetchCloudMarket);
            document.getElementById('close-market-btn')?.addEventListener('click', () => {
                document.getElementById('cloud-market-overlay').style.display = 'none';
            });

            document.getElementById('open-multiplayer-btn')?.addEventListener('click', () => {
                document.getElementById('multiplayer-overlay').style.display = 'flex';
            });
            document.getElementById('close-multiplayer-btn')?.addEventListener('click', () => {
                document.getElementById('multiplayer-overlay').style.display = 'none';
                if (unsubRoom) unsubRoom();
            });
            document.getElementById('create-room-btn')?.addEventListener('click', createMultiplayerRoom);
            document.getElementById('join-room-btn')?.addEventListener('click', joinMultiplayerRoom);
            document.getElementById('start-multiplayer-game-btn')?.addEventListener('click', triggerStartGame);

            // Á∂ÅÂÆöÂÖ®Âüü‰∏ãËºâÂáΩÂºè (Âõ†ÁÇ∫ÂÆÉÊòØÂãïÊÖãÁîüÊàêÁöÑ)
            window.importCloudPool = importCloudPool;
            document.getElementById('check-btn').addEventListener('click', () => checkAnswer(false));
            document.getElementById('view-market-btn').onclick = fetchCloudMarket;
            document.getElementById('upload-cloud-btn').onclick = uploadCustomPoolToCloud;
            document.getElementById('open-multiplayer-btn').onclick = () => document.getElementById('multiplayer-overlay').style.display = 'flex';
            document.getElementById('close-multiplayer-btn').onclick = () => { document.getElementById('multiplayer-overlay').style.display = 'none'; if (unsubRoom) unsubRoom(); };
            document.getElementById('create-room-btn').onclick = createMultiplayerRoom;
            document.getElementById('join-room-btn').onclick = joinMultiplayerRoom;
            document.getElementById('start-multiplayer-game-btn').onclick = triggerStartGame;
            document.getElementById('clear-btn').addEventListener('click', () => {
                playSound('touch');
                if (userAnswer.length > 0) {
                    userAnswer = userAnswer.slice(0, -1);
                }
                updateAnswerDisplay();
            });
            document.getElementById('quit-level-btn').addEventListener('click', () => {
                clearInterval(countdownInterval);
                currentCombo = 0;
                showConfirm('‚ùì Á¢∫ÂÆöË¶ÅÊîæÊ£ÑÂóéÔºü', 'ÈÄô‰∏ÄÈóúÁöÑÈÄ≤Â∫¶Â∞á‰∏çÊúÉÂÑ≤Â≠òÂñîÔºÅË¶ÅÂõûÂú∞ÂúñÈÅ∏ÂñÆÂóéÔºü', () => {
                    showScreen('levelSelect');
                });
            });
            resetButton.addEventListener('click', () => {
                showParentLock(() => {
                    showConfirm('‚ö†Ô∏è Ë≠¶Âëä', 'Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÈÅäÊà≤ÈÄ≤Â∫¶ËàáÊàêÂ∞±ÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÈÇÑÂéüÂñîÔºÅ', () => {
                        gameState = { unlockedLevels: 1, hearts: {}, achievements: [] };
                        saveGameState();
                        updateLevelSelectScreen();
                        renderAchievements();
                    });
                });
            });
            muteBtn.addEventListener('click', () => { isMuted = !isMuted; muteBtn.textContent = isMuted ? 'üîá' : 'üîä'; toggleBgm(); });

            // Level Select Events
            document.getElementById('back-to-home-from-map').onclick = () => { playSound('touch'); showScreen('start'); };

            // Parent Dashboard Events
            document.getElementById('open-parent-btn').onclick = () => {
                showParentLock(() => {
                    renderCustomPoolList();
                    showScreen('parentDashboard');
                });
            };
            document.getElementById('close-parent-btn').onclick = () => showScreen('start');
            document.getElementById('add-custom-btn').onclick = () => {
                const char = document.getElementById('custom-char').value.trim();
                const bopomofo = document.getElementById('custom-bopomofo').value.trim();
                if (!char || !bopomofo) return alert('Ë´ãÂÆåÊï¥Ëº∏ÂÖ•ÂúãÂ≠óËàáÊ≥®Èü≥ÔºÅ');
                customPool.push({ char, bopomofo, image: '' });
                document.getElementById('custom-char').value = '';
                document.getElementById('custom-bopomofo').value = '';
                saveCustomPool();
                updateLevelSelectScreen();
            };

            document.getElementById('share-qr-btn').onclick = () => {
                if (customPool.length === 0) return alert('È°åÂ∫´ÊòØÁ©∫ÁöÑÔºåÁÑ°Ê≥ïÂàÜ‰∫´ÂñîÔºÅ');
                const encoded = btoa(JSON.stringify(customPool));
                const shareUrl = window.location.origin + window.location.pathname + '?import=' + encoded;

                document.getElementById('qr-overlay').style.display = 'flex';
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: shareUrl,
                    width: 256,
                    height: 256
                });
            };
            document.getElementById('close-qr-btn').onclick = () => {
                document.getElementById('qr-overlay').style.display = 'none';
            };

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then((registration) => {
                        console.log('SW: Registered successfully with scope:', registration.scope);
                    }, (err) => {
                        console.log('SW: Registration failed:', err);
                    });
                });
            }



            // --- „Äêv3.3.0„ÄëÂÆ∂Èï∑ÈéñËàáË≠∑ÁúºÊ©üÂà∂Ê†∏ÂøÉÈÇèËºØ ---
            let totalPlayTime = 0; // Á¥ØË®àÈÅäÁé©ÁßíÊï∏
            let healthAlertActive = false;
            const HEALTH_LIMIT = 20 * 60; // 20 ÂàÜÈêò

            function showParentLock(callback) {
                const overlay = document.getElementById('parent-lock-overlay');
                const qDiv = document.getElementById('lock-question');
                const input = document.getElementById('lock-input');
                const a = Math.floor(Math.random() * 20) + 1;
                const b = Math.floor(Math.random() * 20) + 1;
                const correctAnswer = a + b;

                qDiv.textContent = `${a} + ${b} = ?`;
                input.value = '';
                overlay.style.display = 'flex';
                input.focus();

                const confirmBtn = document.getElementById('lock-confirm-btn');
                const cancelBtn = document.getElementById('lock-cancel-btn');

                const cleanup = () => {
                    overlay.style.display = 'none';
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                };

                confirmBtn.onclick = () => {
                    if (parseInt(input.value) === correctAnswer) {
                        cleanup();
                        callback();
                    } else {
                        mascot.say("ÂìéÂëÄÔºåÁÆóÈåØÂõâÔºÅ");
                        input.value = '';
                        input.focus();
                    }
                };

                cancelBtn.onclick = cleanup;
            }

            // Ë≠∑ÁúºË®àÊôÇÂô®
            setInterval(() => {
                if (healthAlertActive) return;
                totalPlayTime++;
                if (totalPlayTime >= HEALTH_LIMIT) {
                    triggerHealthAlert();
                }
            }, 1000);

            function triggerHealthAlert() {
                healthAlertActive = true;
                const overlay = document.getElementById('health-alert-overlay');
                const timerDiv = document.getElementById('health-timer');
                overlay.style.display = 'flex';
                let remaining = 20;

                const itv = setInterval(() => {
                    remaining--;
                    timerDiv.textContent = `Ââ©È§òÊôÇÈñìÔºö${remaining} Áßí`;
                    if (remaining <= 0) {
                        clearInterval(itv);
                        overlay.style.display = 'none';
                        totalPlayTime = 0; // ÈáçÁΩÆË®àÊôÇ
                        healthAlertActive = false;
                        mascot.say("‰ºëÊÅØÂÆåÁï¢ÔºåÊàëÂÄëÁπºÁ∫åÂêßÔºÅ");
                    }
                }, 1000);
            }

            // Â†±ÂëäÂåØÂá∫ÂäüËÉΩ
            document.getElementById('export-report-btn').onclick = () => {
                const canvas = document.getElementById('radar-canvas');
                if (!canvas) return;

                // Âª∫Á´ã‰∏ÄÂÄãÈõ¢Â±èÁï´Â∏É‰æÜÁπ™Ë£ΩÂÆåÊï¥Â†±Âëä
                const reportCanvas = document.createElement('canvas');
                reportCanvas.width = 500;
                reportCanvas.height = 700;
                const ctx = reportCanvas.getContext('2d');

                // ËÉåÊôØ
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, reportCanvas.width, reportCanvas.height);

                // Ê®ôÈ°å
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 28px sans-serif';
                ctx.fillText('„ÑÖ„ÑÜ„Ñá Ê≥®Èü≥Â§ßÊåëÊà∞ - Â≠∏ÁøíÂ†±Âëä', 50, 60);

                // Áï´‰∏äÈõ∑ÈÅîÂúñ
                ctx.drawImage(canvas, 100, 100, 300, 300);

                // Áµ±Ë®àË≥áË®ä
                ctx.font = '20px sans-serif';
                ctx.fillText(`ÁîüÊàêÊó•ÊúüÔºö${new Date().toLocaleDateString()}`, 50, 450);

                let y = 500;
                ctx.fillText('Âº±ÈªûÁ¨¶ËôüÂàÜÊûêÔºö', 50, y);
                y += 35;
                const weakSpots = Object.entries(bopomofoStats)
                    .filter(([k, v]) => v.total >= 3 && (v.correct / v.total) < 0.7)
                    .slice(0, 5);

                if (weakSpots.length === 0) {
                    ctx.fillStyle = '#6BCB77';
                    ctx.fillText('Â§™Ê£í‰∫ÜÔºÅÁõÆÂâçÊ≤íÊúâÊòéÈ°ØÂº±Èªû„ÄÇ', 70, y);
                } else {
                    ctx.fillStyle = '#EF4444';
                    weakSpots.forEach(([k, v]) => {
                        ctx.fillText(`‚Ä¢ ${k} (Ê≠£Á¢∫Áéá: ${Math.round((v.correct / v.total) * 100)}%)`, 70, y);
                        y += 30;
                    });
                }

                // ËΩâÁÇ∫ÂúñÁâá‰∏ãËºâ
                const link = document.createElement('a');
                link.download = `Zhuyin_Report_${new Date().getTime()}.png`;
                link.href = reportCanvas.toDataURL('image/png');
                link.click();
                mascot.say("Â†±ÂëäÂ∑≤ÂåØÂá∫ÂõâÔºÅ");
            };

            // --- AI Ë™ûÈü≥Ëæ®Ë≠òËàáÂàÜÊûêÈÇèËºØ (v3.0) ---
            // --- ÂÆ∂Èï∑ÈåÑÈü≥ÂäüËÉΩÈÇèËºØ (v3.2.0) ---
            let mediaRecorder, audioChunks = [];
            const recordBtn = document.getElementById('record-btn');
            const playRecordBtn = document.getElementById('play-record-btn');

            if (recordBtn) {
                recordBtn.onclick = async () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        recordBtn.textContent = 'üî¥ ÈñãÂßãÈåÑÈü≥';
                        recordBtn.style.backgroundColor = '#EF4444';
                    } else {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            mediaRecorder = new MediaRecorder(stream);
                            audioChunks = [];
                            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                            mediaRecorder.onstop = async () => {
                                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                await window.storage.set('media', 'parentEncouagement', audioBlob);
                                playRecordBtn.style.display = 'block';
                                mascot.say("ÈåÑÈü≥Â≠òÂ•ΩÂõâÔºÅ");
                            };
                            mediaRecorder.start();
                            recordBtn.textContent = '‚èπÔ∏è ÂÅúÊ≠¢ÈåÑÈü≥';
                            recordBtn.style.backgroundColor = '#64748b';
                        } catch (e) { alert("ÁÑ°Ê≥ïÂèñÂæóÈ∫•ÂÖãÈ¢®Ê¨äÈôê"); }
                    }
                };
            }

            if (playRecordBtn) {
                playRecordBtn.onclick = async () => {
                    const blob = await window.storage.get('media', 'parentEncouagement');
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        new Audio(url).play();
                    }
                };

                // ÂàùÂßãÂåñÊ™¢Êü•ÊòØÂê¶ÊúâÁèæÊàêÈåÑÈü≥
                window.storage.get('media', 'parentEncouagement').then(blob => {
                    if (blob) playRecordBtn.style.display = 'block';
                });
            }

            async function updateStats(bopomofo, isCorrect) {
                const parts = parseBopomofo(bopomofo);
                const keys = [];
                if (parts.c) keys.push(parts.c);
                if (parts.m) keys.push(parts.m);
                if (parts.f) keys.push(parts.f);
                if (parts.t) keys.push(parts.t || 'Àâ');

                keys.forEach(key => {
                    if (!bopomofoStats[key]) bopomofoStats[key] = { correct: 0, total: 0 };
                    bopomofoStats[key].total++;
                    if (isCorrect) bopomofoStats[key].correct++;
                });

                if (isCorrect) {
                    bopomofoStats.totalCorrect = (bopomofoStats.totalCorrect || 0) + 1;
                }

                await window.storage.set('stats', 'main', bopomofoStats);
            }

            function drawRadarChart() {
                const canvas = document.getElementById('radar-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = canvas.width * 0.35;

                const categories = [
                    { name: "ËÅ≤ÊØç", keys: bopomofoParts.consonants },
                    { name: "‰ªãÊØç", keys: bopomofoParts.medials },
                    { name: "ÈüªÊØç", keys: bopomofoParts.finals },
                    { name: "ËÅ≤Ë™ø", keys: bopomofoParts.tones }
                ];

                const scores = categories.map(cat => {
                    let correct = 0, total = 0;
                    cat.keys.forEach(k => {
                        const stats = bopomofoStats[k] || (k === 'Àâ' ? bopomofoStats['Àâ'] : null);
                        if (stats) {
                            correct += stats.correct;
                            total += stats.total;
                        }
                    });
                    return total === 0 ? 0 : (correct / total);
                });

                if (scores.every(s => s === 0)) {
                    document.getElementById('radar-empty-msg').style.display = 'block';
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    return;
                } else {
                    document.getElementById('radar-empty-msg').style.display = 'none';
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                for (let level = 1; level <= 5; level++) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#e2e8f0';
                    const r = (radius / 5) * level;
                    for (let i = 0; i < categories.length; i++) {
                        const angle = (i * 2 * Math.PI) / categories.length - Math.PI / 2;
                        const x = centerX + r * Math.cos(angle);
                        const y = centerY + r * Math.sin(angle);
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.stroke();
                }

                ctx.textAlign = 'center';
                ctx.font = '700 16px sans-serif';
                ctx.fillStyle = '#1e293b';
                categories.forEach((cat, i) => {
                    const angle = (i * 2 * Math.PI) / categories.length - Math.PI / 2;
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    ctx.strokeStyle = '#cbd5e1';
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(x, y);
                    ctx.stroke();

                    const labelX = centerX + (radius + 25) * Math.cos(angle);
                    const labelY = centerY + (radius + 25) * Math.sin(angle);
                    ctx.fillText(cat.name, labelX, labelY);
                });

                ctx.beginPath();
                ctx.fillStyle = 'rgba(79, 70, 229, 0.4)';
                ctx.strokeStyle = '#4F46E5';
                ctx.lineWidth = 3;
                scores.forEach((score, i) => {
                    const angle = (i * 2 * Math.PI) / categories.length - Math.PI / 2;
                    const r = radius * Math.max(0.1, score); // ÊúÄÂ∞èÈ°ØÁ§∫ 0.1
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            const voiceBtn = document.getElementById('voice-btn');
            let recognition;
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'zh-TW';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    voiceBtn.classList.add('recording');
                    voiceBtn.textContent = 'üõë';
                };

                recognition.onend = () => {
                    voiceBtn.classList.remove('recording');
                    voiceBtn.textContent = 'üé§';
                };

                recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript;
                    const targetChar = currentQuestions[currentQuestionIndex].char;
                    if (result.includes(targetChar)) {
                        userAnswer = currentQuestions[currentQuestionIndex].bopomofo;
                        updateAnswerDisplay();
                        setTimeout(() => checkAnswer(false), 500);
                    } else {
                        feedbackMessage.textContent = `ËÅΩËµ∑‰æÜÂÉèÊòØ„Äå${result}„ÄçÔºåÂÜçË©¶‰∏ÄÊ¨°ÔºÅ`;
                        feedbackMessage.className = 'feedback-wrong';
                    }
                };
            }

            voiceBtn.onclick = () => {
                if (!recognition) return alert('ÂæàÊä±Ê≠âÔºåÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠òÊúçÂãô„ÄÇÂª∫Ë≠∞‰ΩøÁî® Chrome ÁÄèË¶ΩÂô®„ÄÇ');
                playSound('touch');
                try { recognition.start(); } catch (e) { recognition.stop(); }
            };

            const originalOpenParent = document.getElementById('open-parent-btn').onclick;
            document.getElementById('open-parent-btn').onclick = () => {
                originalOpenParent();
                setTimeout(drawRadarChart, 100);
            };

            document.getElementById('import-code-btn').onclick = async () => {
                const codeInput = document.getElementById('market-code-input');
                const code = codeInput.value.trim();
                if (!code || code.length !== 6) return alert("Ë´ãËº∏ÂÖ• 6 ‰ΩçÊï∏Ê≠£Á¢∫‰ª£Á¢º");
                const btn = document.getElementById('import-code-btn');
                btn.textContent = "..."; btn.disabled = true;
                await window.importCloudPool(code);
                btn.textContent = "Áç≤Âèñ"; btn.disabled = false;
                codeInput.value = '';
            };

            createKeyboard();
        });
    </script>
</body>

</html>